<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <meta name="description" content="Real-time multilingual video classroom with live transcription and translation - 10x more robust than Zoom"/>
  <meta name="theme-color" content="#0b0b0c"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="apple-mobile-web-app-title" content="Success Class"/>
  <link rel="manifest" href="manifest.json"/>
  <link rel="icon" type="image/svg+xml" href="logo.svg"/>
  <link rel="apple-touch-icon" href="icon-192.png"/>
  <title>Success Class – Real-time Translation Classroom</title>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <!-- Stream Video JS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@stream-io/video-client@latest/dist/index.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

  <style>
:root{
  --bg:#0b0b0c;
  --surface: rgba(22,22,24,.78);
  --surface2: rgba(30,30,33,.82);
  --surface3: rgba(40,40,45,.88);

  --border: rgba(255,255,255,.08);
  --border2: rgba(255,255,255,.12);

  --text:#f5f5f5;
  --text-muted: rgba(245,245,245,.58);

  --accent:#6366f1;
  --accent2:#4f46e5;

  --green:#22c55e;
  --red:#ef4444;
  --yellow:#eab308;
  --cyan:#06b6d4;

  --radius: 12px;
  --radius2: 16px;
  --shadow: 0 28px 70px rgba(0,0,0,.55);

  --nav-safe: env(safe-area-inset-bottom);
  --top-safe: env(safe-area-inset-top);
}

*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
  background:
    radial-gradient(1200px 600px at 20% -10%, rgba(99,102,241,.18), transparent 55%),
    radial-gradient(900px 500px at 85% 10%, rgba(6,182,212,.12), transparent 60%),
    radial-gradient(900px 500px at 50% 110%, rgba(34,197,94,.08), transparent 55%),
    var(--bg);
  color:var(--text);
  overflow:hidden;
  -webkit-touch-callout:none;-webkit-user-select:none;user-select:none;touch-action:pan-y;
}

button{cursor:pointer;border:none;background:none;color:inherit;font:inherit}
input,select,textarea{font:inherit}

::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,.12);border-radius:3px}

/* ---------- Loading ---------- */
.loading-overlay{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px;text-align:center}
.loading-card{
  width:100%;max-width:440px;
  background: var(--surface);
  border:1px solid var(--border);
  border-radius:20px;
  padding:28px;
  box-shadow: var(--shadow);
  -webkit-backdrop-filter: blur(16px);
  backdrop-filter: blur(16px);
}
.loading-icon{width:56px;height:56px;border-radius:16px;background:linear-gradient(135deg,var(--accent),var(--cyan));display:flex;align-items:center;justify-content:center;margin:0 auto 14px;font-size:22px}
.loading-title{font-size:18px;font-weight:750;margin-bottom:8px}
.loading-text{font-size:14px;color:var(--text-muted);line-height:1.5}
.loading-actions{margin-top:16px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
.loading-btn{padding:10px 16px;border-radius:12px;background:var(--accent);color:#fff;text-decoration:none;font-size:13px;font-weight:700}
.loading-btn.secondary{background:rgba(255,255,255,.06);border:1px solid var(--border);color:var(--text)}
.loading-overlay.hidden{display:none}
.is-hidden{display:none}

/* ---------- Prejoin ---------- */
.prejoin-overlay{
  position:fixed;inset:0;display:none;z-index:9998;padding:20px;overflow-y:auto;
}
.prejoin-overlay.active{display:flex;align-items:center;justify-content:center}
.prejoin-container{
  width:100%;max-width:980px;
  display:grid;grid-template-columns:1.1fr 1fr;gap:22px;
  border-radius:24px;
  overflow:hidden;
  background: var(--surface);
  border:1px solid var(--border);
  box-shadow: var(--shadow);
  -webkit-backdrop-filter: blur(18px);
  backdrop-filter: blur(18px);
}
@media(max-width:860px){.prejoin-container{grid-template-columns:1fr;max-width:560px}}

.prejoin-preview{
  padding:22px;
  background:
    radial-gradient(900px 420px at 10% 10%, rgba(99,102,241,.18), transparent 55%),
    radial-gradient(700px 420px at 90% 30%, rgba(6,182,212,.12), transparent 60%),
    rgba(10,10,11,.6);
  border-right:1px solid var(--border);
}
@media(max-width:860px){.prejoin-preview{border-right:none;border-bottom:1px solid var(--border)}}

.prejoin-video-wrapper{
  position:relative;width:100%;aspect-ratio:16/9;
  background:rgba(15,15,17,.55);
  border-radius:16px;overflow:hidden;margin-bottom:14px;
  border:1px solid var(--border);
  box-shadow: inset 0 0 0 1px rgba(0,0,0,.2);
}
.prejoin-video-wrapper video{width:100%;height:100%;object-fit:cover;transform:scaleX(-1)}
.prejoin-video-off{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(20,20,22,.85);color:var(--text-muted)}
.prejoin-video-off i{font-size:42px;margin-bottom:10px}
.prejoin-video-off.hidden{display:none}

.prejoin-controls{display:flex;justify-content:center;gap:12px}
.prejoin-toggle{
  width:54px;height:54px;border-radius:999px;
  border:1px solid var(--border);
  background: rgba(255,255,255,.06);
  display:flex;align-items:center;justify-content:center;font-size:18px;
  transition:.14s ease;
}
.prejoin-toggle:hover{transform:translateY(-1px);border-color:var(--border2);background:rgba(255,255,255,.08)}
.prejoin-toggle.off{background:rgba(239,68,68,.18);border-color:rgba(239,68,68,.35);color:#fff}

.prejoin-form{
  padding:28px;
  display:flex;flex-direction:column;
  gap:12px;
}
.prejoin-title{display:flex;flex-direction:column;gap:6px;margin-bottom:8px}
.prejoin-title h2{font-size:24px;letter-spacing:.2px}
.prejoin-title p{color:var(--text-muted);font-size:14px;line-height:1.35}

.prejoin-user{
  display:flex;align-items:center;gap:12px;padding:14px;
  background: rgba(255,255,255,.05);
  border:1px solid var(--border);
  border-radius:14px;
}
.prejoin-user-avatar{
  width:46px;height:46px;border-radius:999px;
  background: linear-gradient(135deg,var(--accent),var(--cyan));
  display:flex;align-items:center;justify-content:center;font-weight:800;font-size:16px;
}
.prejoin-user-avatar img{width:100%;height:100%;border-radius:999px;object-fit:cover}
.prejoin-user-info h4{font-size:15px;font-weight:750}
.prejoin-user-info p{font-size:12px;color:var(--text-muted);margin-top:2px}

.field{display:flex;flex-direction:column;gap:7px}
.field label{font-size:12px;color:var(--text-muted);display:flex;align-items:center;gap:8px}
.field label i{opacity:.9}
.field input,.field select{
  width:100%;
  padding:12px 12px;
  border-radius:12px;
  background: rgba(255,255,255,.06);
  border:1px solid var(--border);
  color:var(--text);
  outline:none;
  transition:.14s ease;
}
.field input:focus,.field select:focus{border-color:rgba(99,102,241,.55);box-shadow:0 0 0 4px rgba(99,102,241,.14)}

.prejoin-room{
  display:flex;gap:8px;align-items:center;
  padding:8px;background:rgba(255,255,255,.05);
  border:1px solid var(--border);
  border-radius:14px;
}
.prejoin-room-prefix{
  padding:12px 12px;border-radius:12px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.06);
  font-weight:900;font-size:12px;letter-spacing:.8px;
  color:rgba(99,102,241,.95);
}
.prejoin-room input{
  flex:1;
  padding:12px 12px;border-radius:12px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.06);
  font-weight:850;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  letter-spacing:2.5px;
  text-transform:uppercase;
}

.prejoin-actions{display:flex;flex-direction:column;gap:10px;margin-top:6px}
.btn-primary{
  width:100%;
  padding:14px 14px;
  border-radius:14px;
  background: linear-gradient(135deg,var(--accent),var(--cyan));
  color:#fff;
  font-weight:850;
  letter-spacing:.2px;
  box-shadow: 0 14px 35px rgba(0,0,0,.35);
  transition:.14s ease;
}
.btn-primary:hover{transform:translateY(-1px);filter:brightness(1.05)}
.btn-primary:active{transform:translateY(0)}
.btn-secondary{
  width:100%;
  padding:12px 14px;
  border-radius:14px;
  border:1px solid var(--border);
  background: rgba(255,255,255,.06);
  color:var(--text-muted);
  font-weight:750;
}
.btn-secondary:hover{background:rgba(255,255,255,.08);color:var(--text)}
.small-note{font-size:12px;color:var(--text-muted);text-align:center;margin-top:2px}

/* ---------- App Shell ---------- */
.app-container{display:none;height:100%;flex-direction:column}
.app-container.active{display:flex}

/* Sticky header */
.topbar{
  position:sticky;top:0;z-index:200;
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 14px calc(10px + var(--top-safe));
  background: rgba(18,18,20,.70);
  border-bottom:1px solid var(--border);
  -webkit-backdrop-filter: blur(16px);
  backdrop-filter: blur(16px);
}
.topbar-left{display:flex;align-items:center;gap:10px;min-width:0}
.brand{
  display:flex;align-items:center;gap:10px;min-width:0
}
.brand-icon{
  width:34px;height:34px;border-radius:10px;
  background:linear-gradient(135deg,var(--accent),var(--cyan));
  display:flex;align-items:center;justify-content:center;
  box-shadow: 0 10px 25px rgba(0,0,0,.22);
}
.brand-text{display:flex;flex-direction:column;gap:2px;min-width:0}
.brand-title{font-weight:900;font-size:14px;letter-spacing:.2px}
.brand-sub{font-size:12px;color:var(--text-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

.room-pill{
  display:flex;align-items:center;gap:10px;
  padding:7px 10px;border-radius:12px;
  border:1px solid var(--border);
  background: rgba(255,255,255,.05);
  font-size:12px;
}
.room-pill code{
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  color: rgba(99,102,241,.95);
  font-weight:850;
  letter-spacing:1px;
}
.dot{width:7px;height:7px;border-radius:999px;background:rgba(245,245,245,.25)}
.dot.live{background:var(--red);box-shadow:0 0 0 6px rgba(239,68,68,.12)}
.dot.ok{background:var(--green);box-shadow:0 0 0 6px rgba(34,197,94,.12)}
.dot.warn{background:var(--yellow);box-shadow:0 0 0 6px rgba(234,179,8,.12)}

.topbar-center{display:flex;justify-content:center;flex:1}
.timer{
  display:flex;align-items:center;gap:8px;
  padding:7px 10px;border-radius:12px;
  border:1px solid var(--border);
  background: rgba(255,255,255,.05);
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  font-size:12px;
}
.timer i{color:var(--red)}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.35}}
.timer.recording i{animation:blink 1s infinite}

.topbar-right{display:flex;align-items:center;gap:8px}
.icon-btn{
  width:40px;height:40px;border-radius:12px;
  border:1px solid var(--border);
  background: rgba(255,255,255,.05);
  display:flex;align-items:center;justify-content:center;
  transition:.14s ease;
}
.icon-btn:hover{transform:translateY(-1px);border-color:var(--border2);background:rgba(255,255,255,.08)}
.icon-btn.danger{background:rgba(239,68,68,.18);border-color:rgba(239,68,68,.35);color:#fff}
.icon-btn.danger:hover{background:rgba(239,68,68,.25)}
.role-chip{
  padding:7px 10px;border-radius:999px;
  border:1px solid var(--border);
  background: rgba(255,255,255,.05);
  font-size:12px;color:var(--text-muted);
}

/* Workspace 3-col */
.workspace{
  flex:1;
  display:flex;
  gap:10px;
  padding:10px;
  min-height:0; /* critical for inner scroll */
}
.panel{
  background: var(--surface);
  border:1px solid var(--border);
  border-radius: var(--radius2);
  box-shadow: 0 20px 60px rgba(0,0,0,.38);
  -webkit-backdrop-filter: blur(16px);
  backdrop-filter: blur(16px);
  overflow:hidden;
  min-height:0;
}

.teacher-tile{
  width:360px;flex:0 0 360px;
  display:flex;flex-direction:column;
}
.feed-column{
  flex:1;display:flex;flex-direction:column;min-width:0;
}
.students-column{
  width:320px;flex:0 0 320px;
  display:flex;flex-direction:column;
}

.panel-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:12px 14px;
  border-bottom:1px solid var(--border);
  background: rgba(255,255,255,.03);
}
.panel-title{
  display:flex;align-items:center;gap:10px;
  font-weight:900;font-size:13px;letter-spacing:.3px;
}
.panel-title span{color:var(--text-muted);font-weight:700;font-size:12px}
.header-actions{display:flex;align-items:center;gap:8px}
.pill-btn{
  padding:8px 10px;border-radius:12px;
  border:1px solid var(--border);
  background: rgba(255,255,255,.05);
  font-size:12px;font-weight:800;
  transition:.14s ease;
}
.pill-btn:hover{transform:translateY(-1px);border-color:var(--border2);background:rgba(255,255,255,.08)}
.pill-btn.primary{
  border:none;
  background: linear-gradient(135deg,var(--accent),var(--cyan));
  color:#fff;
}
.pill-btn.primary:hover{filter:brightness(1.05)}
.pill-btn.danger{
  background: rgba(239,68,68,.18);
  border-color: rgba(239,68,68,.35);
  color:#fff;
}
.pill-btn.danger:hover{background:rgba(239,68,68,.24)}
.badge{
  font-size:10px;font-weight:900;
  padding:3px 8px;border-radius:999px;
  border:1px solid var(--border);
  background: rgba(255,255,255,.05);
  color:var(--text-muted);
}
.badge.live{color:#fff;border:none;background: rgba(239,68,68,.85)}

/* Teacher body */
.teacher-body{display:flex;flex-direction:column;gap:10px;padding:12px 12px 14px;min-height:0}
.teacher-video{
  position:relative;
  aspect-ratio:16/9;
  border-radius:14px;
  background: rgba(255,255,255,.05);
  border:1px solid var(--border);
  overflow:hidden;
}
.teacher-video video{width:100%;height:100%;object-fit:cover}
.teacher-video .placeholder{
  position:absolute;inset:0;
  display:flex;align-items:center;justify-content:center;
  color:var(--text-muted);
  background: rgba(15,15,17,.6);
  gap:10px;
}
.teacher-video .placeholder i{font-size:24px;opacity:.75}
.teacher-statusbar{
  display:flex;align-items:center;justify-content:space-between;
  gap:10px;
  padding:10px 12px;
  border:1px solid var(--border);
  background: rgba(255,255,255,.05);
  border-radius:14px;
}
.status{
  display:flex;align-items:center;gap:8px;
  font-size:12px;color:var(--text-muted);
}
.status strong{color:var(--text);font-weight:900}
.status .dot{width:8px;height:8px}
.teacher-controls{
  display:flex;flex-direction:column;gap:10px;
  padding:12px;
  border:1px solid var(--border);
  background: rgba(255,255,255,.05);
  border-radius:14px;
}
.teacher-controls.hidden{display:none}
.ctrl-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.ctrl{display:flex;flex-direction:column;gap:6px}
.ctrl label{font-size:11px;color:var(--text-muted);display:flex;gap:6px;align-items:center}
.ctrl select{
  padding:10px 10px;border-radius:12px;
  border:1px solid var(--border);
  background: rgba(255,255,255,.06);
  color:var(--text);
  outline:none;
}
.ctrl select:focus{border-color:rgba(99,102,241,.55);box-shadow:0 0 0 4px rgba(99,102,241,.14)}
.teacher-buttons{display:flex;gap:10px}
.teacher-buttons .pill-btn{flex:1;justify-content:center;display:flex;gap:8px;align-items:center}
.teacher-note{font-size:12px;color:var(--text-muted);line-height:1.35}

/* Feed */
.feed-body{display:flex;flex-direction:column;min-height:0}
.feed-scroll{
  flex:1;
  overflow:auto;
  padding:12px;
  min-height:0;
}
.feed-empty{
  height:100%;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  color:var(--text-muted);
  padding:28px;
  text-align:center;
}
.feed-empty i{font-size:44px;margin-bottom:12px;opacity:.55}
.feed-item{
  border:1px solid var(--border);
  background: rgba(255,255,255,.05);
  border-radius:14px;
  padding:12px;
  margin-bottom:10px;
}
.feed-top{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.avatar{
  width:28px;height:28px;border-radius:999px;
  background: linear-gradient(135deg,var(--accent),var(--cyan));
  display:flex;align-items:center;justify-content:center;
  font-size:11px;font-weight:900;
}
.feed-meta{display:flex;flex-direction:column;gap:2px;min-width:0}
.feed-name{font-size:12px;font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.feed-time{font-size:11px;color:var(--text-muted)}
.feed-bodyline{display:flex;flex-direction:column;gap:8px}
.source{
  font-size:13px;line-height:1.45;
  color:rgba(245,245,245,.60);
  border-left:3px solid rgba(245,245,245,.20);
  padding:9px 10px;
  border-radius:10px;
  background: rgba(0,0,0,.18);
}
.translation{
  font-size:14px;line-height:1.45;
  color:rgba(245,245,245,.95);
  border-left:3px solid rgba(99,102,241,.85);
  padding:10px 10px;
  border-radius:10px;
  background: rgba(99,102,241,.10);
}
.feed-actions{display:flex;gap:8px;margin-top:10px}
.feed-actions .pill-btn{padding:7px 10px;font-size:12px}
.feed-actions .pill-btn.playing{background:rgba(34,197,94,.18);border-color:rgba(34,197,94,.35);color:#fff}

.composer{
  border-top:1px solid var(--border);
  padding:10px;
  display:flex;gap:10px;
  background: rgba(255,255,255,.03);
}
.composer input{
  flex:1;
  padding:12px 12px;
  border-radius:14px;
  border:1px solid var(--border);
  background: rgba(255,255,255,.06);
  color:var(--text);
  outline:none;
}
.composer input:focus{border-color:rgba(99,102,241,.55);box-shadow:0 0 0 4px rgba(99,102,241,.14)}
.composer .pill-btn{padding:10px 12px}

/* Students */
.students-body{display:flex;flex-direction:column;min-height:0}
.students-scroll{flex:1;overflow:auto;padding:12px;min-height:0}
.student-card{
  display:flex;align-items:center;gap:10px;
  padding:10px;border-radius:14px;
  border:1px solid var(--border);
  background: rgba(255,255,255,.05);
  margin-bottom:8px;
}
.student-ava{
  width:38px;height:38px;border-radius:999px;
  background: rgba(99,102,241,.22);
  border:1px solid rgba(99,102,241,.25);
  display:flex;align-items:center;justify-content:center;
  font-weight:900;font-size:13px;color:#fff;
  flex:0 0 auto;
}
.student-ava img{width:100%;height:100%;border-radius:999px;object-fit:cover}
.student-info{flex:1;min-width:0}
.student-info .name{
  display:flex;align-items:center;gap:8px;
  font-size:13px;font-weight:900;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}
.tag{
  font-size:10px;font-weight:900;
  padding:2px 8px;border-radius:999px;
  border:1px solid var(--border);
  background: rgba(255,255,255,.05);
  color:var(--text-muted);
}
.tag.teacher{border-color:rgba(99,102,241,.28);background:rgba(99,102,241,.14);color:rgba(99,102,241,.95)}
.tag.speaker{border-color:rgba(34,197,94,.30);background:rgba(34,197,94,.14);color:#dfffe9}
.tag.hand{border-color:rgba(234,179,8,.30);background:rgba(234,179,8,.14);color:#fff}
.student-info .sub{
  margin-top:3px;
  font-size:11px;color:var(--text-muted);
  display:flex;align-items:center;gap:8px;
}
.mini-dot{width:7px;height:7px;border-radius:999px;background:var(--green);box-shadow:0 0 0 6px rgba(34,197,94,.10)}
.mini-dot.muted{background:var(--red);box-shadow:0 0 0 6px rgba(239,68,68,.10)}
.student-actions{display:flex;gap:6px}
.sbtn{
  width:30px;height:30px;border-radius:10px;
  border:1px solid var(--border);
  background: rgba(255,255,255,.05);
  display:flex;align-items:center;justify-content:center;
  transition:.14s ease;
}
.sbtn:hover{transform:translateY(-1px);border-color:var(--border2);background:rgba(255,255,255,.08)}
.sbtn.accept{border:none;background:rgba(34,197,94,.22);color:#fff}
.sbtn.reject{border:none;background:rgba(239,68,68,.20);color:#fff}

/* Raise-hand queue section */
.queue{
  border-top:1px solid var(--border);
  background: rgba(255,255,255,.03);
  padding:10px 12px;
}
.queue-title{
  display:flex;align-items:center;justify-content:space-between;
  font-size:12px;font-weight:900;
  color:var(--text);
  margin-bottom:8px;
}
.queue-list{display:flex;flex-direction:column;gap:8px;max-height:170px;overflow:auto;padding-right:2px}
.queue-item{
  display:flex;align-items:center;gap:10px;
  padding:10px;border-radius:14px;
  border:1px solid rgba(234,179,8,.20);
  background: rgba(234,179,8,.08);
}
.queue-item .who{flex:1;min-width:0;font-size:12px;font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.queue-item .who small{display:block;font-size:11px;color:rgba(245,245,245,.62);font-weight:700;margin-top:2px}
.queue-actions{display:flex;gap:6px}
.queue-empty{font-size:12px;color:var(--text-muted);padding:8px 0}

/* Toast */
.toast{
  position:fixed;left:50%;transform:translateX(-50%);
  bottom: calc(92px + var(--nav-safe));
  background: rgba(20,20,22,.92);
  border:1px solid var(--border);
  padding:12px 14px;border-radius:14px;
  font-size:13px;font-weight:750;
  z-index:3000;
  display:none;
  box-shadow: 0 18px 50px rgba(0,0,0,.45);
  -webkit-backdrop-filter: blur(12px);
  backdrop-filter: blur(12px);
}
.toast.show{display:block;animation:fadeUp .22s ease}
@keyframes fadeUp{from{opacity:0;transform:translateX(-50%) translateY(12px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}

/* Settings drawer */
.drawer-overlay{
  position:fixed;inset:0;
  display:none;
  background: rgba(0,0,0,.62);
  z-index:2500;
  padding:10px;
}
.drawer-overlay.open{display:block}
.drawer{
  position:absolute;top:10px;right:10px;bottom:10px;
  width:min(520px, 92vw);
  border-radius:20px;
  background: rgba(22,22,24,.92);
  border:1px solid var(--border);
  box-shadow: var(--shadow);
  -webkit-backdrop-filter: blur(16px);
  backdrop-filter: blur(16px);
  display:flex;flex-direction:column;
  transform: translateX(14px);
  animation: drawerIn .18s ease forwards;
}
@keyframes drawerIn{to{transform:translateX(0)}}
.drawer-head{
  display:flex;align-items:center;justify-content:space-between;
  padding:14px 14px;
  border-bottom:1px solid var(--border);
}
.drawer-head h3{display:flex;align-items:center;gap:10px;font-size:14px;font-weight:900}
.drawer-body{flex:1;overflow:auto;padding:14px;display:flex;flex-direction:column;gap:12px}
.drawer-foot{border-top:1px solid var(--border);padding:12px 14px;display:flex;gap:10px;justify-content:flex-end}
.drawer .field input{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
.drawer .field small{color:var(--text-muted);font-size:11px;line-height:1.35}
.toggle{
  width:52px;height:28px;border-radius:999px;
  border:1px solid var(--border);
  background: rgba(255,255,255,.06);
  position:relative;
}
.toggle::after{
  content:'';
  position:absolute;top:3px;left:3px;
  width:22px;height:22px;border-radius:999px;
  background: rgba(245,245,245,.92);
  transition:.14s ease;
}
.toggle.active{background: rgba(34,197,94,.22);border-color: rgba(34,197,94,.32)}
.toggle.active::after{left:27px}
.inline-row{display:flex;align-items:center;justify-content:space-between;padding:6px 0}

/* Mobile bottom bar */
.bottom-bar{
  display:none;
}
@media(max-width:1024px){
  body{overflow:hidden}
  .workspace{
    flex-direction:column;
    padding:10px 10px calc(86px + var(--nav-safe));
  }
  .teacher-tile,.students-column{width:100%;flex:0 0 auto}
  .teacher-tile{order:0}
  .feed-column{order:1}
  .students-column{order:2}
  .teacher-tile{width:auto}
  .students-column{display:none} /* opened via bottom bar */
  .bottom-bar{
    display:flex;
    position:fixed;left:0;right:0;bottom:0;
    padding:10px 12px calc(10px + var(--nav-safe));
    gap:10px;
    background: rgba(18,18,20,.78);
    border-top:1px solid var(--border);
    -webkit-backdrop-filter: blur(16px);
    backdrop-filter: blur(16px);
    z-index:500;
  }
  .bb-btn{
    flex:1;
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    gap:6px;
    padding:10px 8px;
    border-radius:16px;
    border:1px solid var(--border);
    background: rgba(255,255,255,.05);
    transition:.14s ease;
    min-width:0;
  }
  .bb-btn:hover{background:rgba(255,255,255,.08);border-color:var(--border2)}
  .bb-btn i{font-size:18px}
  .bb-btn span{font-size:11px;color:rgba(245,245,245,.72);font-weight:800}
  .bb-btn.primary{
    border:none;
    background: linear-gradient(135deg,var(--accent),var(--cyan));
  }
  .bb-btn.primary span{color:#fff}
  .bb-btn.active{
    background: rgba(99,102,241,.16);
    border-color: rgba(99,102,241,.22);
  }

  /* Mobile Students sheet */
  .mobile-sheet{
    position:fixed;left:10px;right:10px;bottom: calc(74px + var(--nav-safe));top:auto;
    max-height:72vh;
    display:none;
    z-index:800;
  }
  .mobile-sheet.open{display:flex;flex-direction:column}
}

/* Small phone */
@media(max-width:480px){
  .prejoin-container{border-radius:18px}
  .prejoin-form{padding:18px}
  .prejoin-preview{padding:16px}
  .teacher-tile{width:100%}
}
  </style>
</head>

<body>
  <!-- Loading -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-card">
      <div class="loading-icon"><i class="fas fa-circle-notch fa-spin"></i></div>
      <div class="loading-title" id="loadingTitle">Checking authentication</div>
      <div class="loading-text" id="loadingMessage">Please wait while we verify your session.</div>
      <div class="loading-actions is-hidden" id="loadingActions">
        <a class="loading-btn" href="auth.html">Go to Sign In</a>
        <a class="loading-btn secondary" href="index.html">Retry</a>
      </div>
    </div>
  </div>

  <!-- Prejoin -->
  <div class="prejoin-overlay" id="prejoinOverlay">
    <div class="prejoin-container">
      <div class="prejoin-preview">
        <div class="prejoin-video-wrapper">
          <video id="prejoinVideo" autoplay muted playsinline></video>
          <div class="prejoin-video-off" id="prejoinVideoOff">
            <i class="fas fa-video-slash"></i><span>Camera is off</span>
          </div>
        </div>
        <div class="prejoin-controls">
          <button class="prejoin-toggle" id="prejoinMicToggle" title="Mic"><i class="fas fa-microphone"></i></button>
          <button class="prejoin-toggle" id="prejoinCamToggle" title="Camera"><i class="fas fa-video"></i></button>
        </div>
        <div class="small-note" style="margin-top:10px">
          Calm Apple-like UI • Stable panels • Single speaker gate
        </div>
      </div>

      <div class="prejoin-form">
        <div class="prejoin-title">
          <h2>Join Classroom</h2>
          <p>Choose role, devices, and language before entering the room.</p>
        </div>

        <div class="prejoin-user" id="prejoinUser">
          <div class="prejoin-user-avatar" id="prejoinAvatar">?</div>
          <div class="prejoin-user-info">
            <h4 id="prejoinName">User</h4>
            <p id="prejoinEmail">user@example.com</p>
          </div>
        </div>

        <div class="field">
          <label><i class="fas fa-user"></i> Display Name</label>
          <input type="text" id="displayNameInput" placeholder="Enter your name" maxlength="50"/>
        </div>

        <div class="field">
          <label><i class="fas fa-user-tag"></i> Role</label>
          <select id="roleSelect">
            <option value="teacher">Teacher (Operator)</option>
            <option value="student">Student (Muted by default)</option>
          </select>
        </div>

        <div class="prejoin-room">
          <span class="prejoin-room-prefix">CLASS-</span>
          <input type="text" id="roomIdInput" placeholder="ORBIT (default)" maxlength="6" value="ORBIT"/>
        </div>

        <div class="field">
          <label><i class="fas fa-language"></i> Language (Your translation target)</label>
          <select id="userLanguageSelect"></select>
        </div>

        <div class="field">
          <label><i class="fas fa-microphone"></i> Microphone</label>
          <select id="micSelect"></select>
        </div>
        <div class="field">
          <label><i class="fas fa-video"></i> Camera</label>
          <select id="camSelect"></select>
        </div>
        <div class="field">
          <label><i class="fas fa-volume-up"></i> Speaker</label>
          <select id="speakerSelect"></select>
        </div>

        <div class="prejoin-actions">
          <button class="btn-primary" id="btnJoinRoom"><i class="fas fa-sign-in-alt"></i> Join Class</button>
          <button class="btn-secondary" id="btnLogout"><i class="fas fa-sign-out-alt"></i> Sign Out</button>
          <div class="small-note">Students are auto-muted and need Teacher approval to speak.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- App -->
  <div class="app-container" id="appContainer">
    <header class="topbar">
      <div class="topbar-left">
        <div class="brand">
          <div class="brand-icon"><i class="fas fa-graduation-cap"></i></div>
          <div class="brand-text">
            <div class="brand-title">Success Class</div>
            <div class="brand-sub" id="brandSubtitle">Real-time multilingual classroom</div>
          </div>
        </div>
        <div class="room-pill">
          <span class="dot" id="roomDot"></span>
          <span>Room</span>
          <code id="displayRoomId">XXXXXX</code>
          <span style="opacity:.55">•</span>
          <span id="participantCount">1</span>
        </div>
      </div>

      <div class="topbar-center">
        <div class="timer" id="meetingTimer"><i class="fas fa-circle"></i><span id="timerDisplay">00:00</span></div>
      </div>

      <div class="topbar-right">
        <div class="role-chip" id="roleChip">Role: —</div>
        <button class="icon-btn" id="btnOpenSettings" title="Settings"><i class="fas fa-cog"></i></button>
        <button class="icon-btn danger" id="btnLeave" title="Leave"><i class="fas fa-phone-slash"></i></button>
      </div>
    </header>

    <main class="workspace">
      <!-- Left: Teacher Tile -->
      <section class="panel teacher-tile" id="teacherTile">
        <div class="panel-header">
          <div class="panel-title">
            <i class="fas fa-signal"></i>
            <div>Teacher Console <span id="teacherSub">Operator</span></div>
          </div>
          <div class="header-actions">
            <span class="badge" id="liveBadge">IDLE</span>
          </div>
        </div>

        <div class="teacher-body">
          <div class="teacher-video">
            <video id="teacherVideo" autoplay playsinline muted></video>
            <div class="placeholder" id="teacherVideoPlaceholder"><i class="fas fa-video"></i><span>Video surface</span></div>
          </div>

          <div class="teacher-statusbar">
            <div class="status">
              <span class="dot" id="micDot"></span>
              <div><strong id="micState">Muted</strong><div style="font-size:11px;color:var(--text-muted)">Mic state</div></div>
            </div>
            <div class="status">
              <span class="dot" id="connDot"></span>
              <div><strong id="connState">Idle</strong><div style="font-size:11px;color:var(--text-muted)">STT connection</div></div>
            </div>
          </div>

          <div class="teacher-controls" id="teacherControls">
            <div class="ctrl-grid">
              <div class="ctrl">
                <label><i class="fas fa-microphone"></i> Mic Source</label>
                <select id="teacherMicSelect"></select>
              </div>
              <div class="ctrl">
                <label><i class="fas fa-language"></i> Source Lang</label>
                <select id="teacherSourceLang">
                  <option value="auto">Auto</option>
                  <option value="en">English</option>
                  <option value="tl">Tagalog</option>
                  <option value="tr">Turkish</option>
                  <option value="fr">French</option>
                  <option value="nl-BE">Dutch (BE)</option>
                </select>
              </div>
              <div class="ctrl">
                <label><i class="fas fa-globe"></i> Target Lang</label>
                <select id="teacherTargetLang"></select>
              </div>
              <div class="ctrl">
                <label><i class="fas fa-volume-up"></i> Auto-play TTS</label>
                <select id="teacherAutoTts">
                  <option value="off">Off</option>
                  <option value="on">On</option>
                </select>
              </div>
            </div>

            <div class="teacher-buttons">
              <button class="pill-btn primary" id="btnStartSTT"><i class="fas fa-play"></i> Start</button>
              <button class="pill-btn danger" id="btnStopSTT"><i class="fas fa-stop"></i> Stop</button>
            </div>

            <div class="teacher-note" id="teacherNote">
              Teacher starts the live pipeline. Students are muted by default and must raise hand to be granted speaking permission.
            </div>
          </div>
        </div>
      </section>

      <!-- Center: Feed -->
      <section class="panel feed-column" id="feedColumn">
        <div class="panel-header">
          <div class="panel-title"><i class="fas fa-language"></i> Translation Feed <span>unified</span></div>
          <div class="header-actions">
            <button class="pill-btn" id="btnClearFeed"><i class="fas fa-broom"></i> Clear</button>
            <button class="pill-btn" id="btnCopyFeed"><i class="fas fa-copy"></i> Copy</button>
          </div>
        </div>

        <div class="feed-body">
          <div class="feed-scroll" id="feedScroll">
            <div class="feed-empty" id="feedEmpty">
              <i class="fas fa-language"></i>
              <div style="font-weight:900;margin-bottom:6px">Waiting for speech…</div>
              <div style="max-width:360px">Transcripts and translations will appear here as the teacher (or the allowed student) speaks.</div>
            </div>
          </div>

          <div class="composer" id="composer">
            <input id="testComposerInput" placeholder="Test mode: type here to translate without microphone…" maxlength="500"/>
            <button class="pill-btn primary" id="btnSendTest"><i class="fas fa-paper-plane"></i> Send</button>
          </div>
        </div>
      </section>

      <!-- Right: Students -->
      <aside class="panel students-column" id="studentsColumn">
        <div class="panel-header">
          <div class="panel-title"><i class="fas fa-users"></i> Students <span id="studentsSub">participants</span></div>
          <div class="header-actions">
            <button class="pill-btn" id="btnInvite"><i class="fas fa-link"></i> Invite</button>
          </div>
        </div>

        <div class="students-body">
          <div class="students-scroll" id="studentsScroll">
            <div class="feed-empty" style="display:none" id="studentsEmpty">
              <i class="fas fa-users"></i>
              <div style="font-weight:900;margin-bottom:6px">No participants</div>
              <div>Invite someone to join this room.</div>
            </div>
          </div>

          <div class="queue" id="queueBox">
            <div class="queue-title">
              <div><i class="fas fa-hand-paper" style="color:var(--yellow)"></i> Raise-hand Queue</div>
              <span class="badge" id="queueCount">0</span>
            </div>
            <div class="queue-list" id="queueList">
              <div class="queue-empty" id="queueEmpty">No raised hands.</div>
            </div>
          </div>
        </div>
      </aside>

      <!-- Mobile students sheet -->
      <aside class="panel mobile-sheet" id="mobileStudentsSheet">
        <div class="panel-header">
          <div class="panel-title"><i class="fas fa-users"></i> Students <span>panel</span></div>
          <div class="header-actions">
            <button class="pill-btn" id="btnCloseMobileStudents"><i class="fas fa-times"></i> Close</button>
          </div>
        </div>
        <div class="students-body">
          <div class="students-scroll" id="studentsScrollMobile"></div>
          <div class="queue" id="queueBoxMobile">
            <div class="queue-title">
              <div><i class="fas fa-hand-paper" style="color:var(--yellow)"></i> Raise-hand Queue</div>
              <span class="badge" id="queueCountMobile">0</span>
            </div>
            <div class="queue-list" id="queueListMobile"></div>
          </div>
        </div>
      </aside>
    </main>

    <!-- Mobile Bottom Bar -->
    <nav class="bottom-bar">
      <button class="bb-btn primary" id="bbSpeak"><i class="fas fa-microphone"></i><span>Speak</span></button>
      <button class="bb-btn" id="bbTranslate"><i class="fas fa-language"></i><span>Translate</span></button>
      <button class="bb-btn" id="bbStudents"><i class="fas fa-users"></i><span>Students</span></button>
      <button class="bb-btn" id="bbSettings"><i class="fas fa-cog"></i><span>Settings</span></button>
    </nav>
  </div>

  <!-- Settings Drawer -->
  <div class="drawer-overlay" id="settingsOverlay">
    <div class="drawer" role="dialog" aria-modal="true">
      <div class="drawer-head">
        <h3><i class="fas fa-cog"></i> Settings</h3>
        <button class="icon-btn" id="btnCloseSettings" title="Close"><i class="fas fa-times"></i></button>
      </div>

      <div class="drawer-body">
        <div class="field">
          <label><i class="fas fa-hashtag"></i> Room ID</label>
          <input id="setRoomId" type="text" readonly/>
          <small>Room ID is the shared key for participants, queue, and transcripts.</small>
        </div>

        <div class="field">
          <label><i class="fas fa-link"></i> STT Endpoint</label>
          <input id="setSttEndpoint" type="text" placeholder="wss://api.deepgram.com/v1/listen?..."/>
          <small>Used by the Teacher pipeline. Defaults to Deepgram Nova.</small>
        </div>

        <div class="field">
          <label><i class="fas fa-key"></i> Deepgram Key</label>
          <input id="setDeepgramKey" type="password" placeholder="token"/>
        </div>

        <div class="field">
          <label><i class="fas fa-key"></i> Cartesia Key</label>
          <input id="setCartesiaKey" type="password" placeholder="sk_..."/>
        </div>

        <div class="field">
          <label><i class="fas fa-wave-square"></i> Cartesia Model</label>
          <input id="setCartesiaModel" type="text" placeholder="sonic-3"/>
        </div>

        <div class="inline-row">
          <div style="display:flex;flex-direction:column;gap:2px">
            <div style="font-weight:900;font-size:13px">Noise suppression</div>
            <div style="font-size:11px;color:var(--text-muted)">Applies to local mic capture.</div>
          </div>
          <div class="toggle active" id="setNoiseToggle"></div>
        </div>

        <div class="inline-row">
          <div style="display:flex;flex-direction:column;gap:2px">
            <div style="font-weight:900;font-size:13px">Echo cancellation</div>
            <div style="font-size:11px;color:var(--text-muted)">Applies to local mic capture.</div>
          </div>
          <div class="toggle active" id="setEchoToggle"></div>
        </div>

        <div class="inline-row">
          <div style="display:flex;flex-direction:column;gap:2px">
            <div style="font-weight:900;font-size:13px">Auto gain control</div>
            <div style="font-size:11px;color:var(--text-muted)">Applies to local mic capture.</div>
          </div>
          <div class="toggle active" id="setGainToggle"></div>
        </div>
      </div>

      <div class="drawer-foot">
        <button class="pill-btn" id="btnResetSettings"><i class="fas fa-rotate-left"></i> Reset</button>
        <button class="pill-btn primary" id="btnSaveSettings"><i class="fas fa-check"></i> Save</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/* =========================
   Firebase Config
========================= */
const firebaseConfig = {
  apiKey: "AIzaSyDVw2Xt1gf52xXgx4E5TMKf2007AyQwBfQ",
  authDomain: "impactful-ring-469323-e5.firebaseapp.com",
  databaseURL: "https://impactful-ring-469323-e5.europe-west1.firebasedatabase.app",
  projectId: "impactful-ring-469323-e5",
  storageBucket: "impactful-ring-469323-e5.firebasestorage.app",
  messagingSenderId: "316842561818",
  appId: "1:316842561818:web:8e580f90d4c766832c5ca3"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth(), db = firebase.database();
const $ = id => document.getElementById(id);

/* =========================
   Stream Video Configuration (kept)
========================= */
const STREAM_API_KEY = 'pnh7nmt84ebm';
const STREAM_SECRET_KEY = 'ycewy9r3x5597e39j7ay7q5v7fw2vsybqb65gfu2n6nrzab7vw4q63bdkyh8f3f6';
const USER_TOKEN_EXPIRY_HOURS = 24;

/* =========================
   Voice Mapping (kept)
========================= */
const UNIVERSAL_VOICE = 'a0e99841-438c-4a64-b679-ae501e7d6091';
const VOICES = {
  'en':'a0e99841-438c-4a64-b679-ae501e7d6091','en-US':'a0e99841-438c-4a64-b679-ae501e7d6091','en-GB':'a0e99841-438c-4a64-b679-ae501e7d6091',
  'es':'846d6cb0-2301-48b6-9571-6d4e2685d80c','fr':'a8a1eb38-5f15-4c1d-8722-7ac0f329f8f3',
  'de':'3f6e78a8-5283-42aa-b5e7-af82e8bb310c','it':'03496517-369a-4db1-8236-3d3ae459ddf7',
  'pt':'700d1ee3-a641-4018-ba6e-899dcadc9e2b','nl':'daf747c6-6bc2-4083-bd59-aa94dce23f5d','nl-BE':'daf747c6-6bc2-4083-bd59-aa94dce23f5d','vls':'daf747c6-6bc2-4083-bd59-aa94dce23f5d',
  'zh':'eda5bbff-1ff1-4886-8ef1-4e69a77640a0','ja':'2b568345-1d48-4047-b25f-7baccf842eb0',
  'ko':'029c3c7a-b6d9-44fb-a9b9-e91c9c7b3a6e','ar':'cfa77df6-e0a1-4c8a-a239-7e8deb0d1cb2',
  'hi':'4a19f17c-eedc-4cf6-b89b-3efb5c8c8a4e','ru':'2d8c8d5f-6bb3-44a6-afd2-a5e05d2caca7',
  'tr':'d46abd1d-2d02-43e8-819f-51fb652c1c61','pl':'f9836c6e-a0bd-460e-9d3c-f7a1a84d2d4e',
  'vi':'41534e16-2966-4c6b-9670-111411def906','th':'3b554273-4299-48b9-9aaf-eefd438e3941',
  'id':'bf991597-6c13-47e4-8411-91ec2de5c466','tl':'daf747c6-6bc2-4083-bd59-aa94dce23f5d','fil':'daf747c6-6bc2-4083-bd59-aa94dce23f5d','tl-PH':'daf747c6-6bc2-4083-bd59-aa94dce23f5d'
};
function getVoice(l){
  if(VOICES[l]) return VOICES[l];
  const base = (l||'').split('-')[0];
  if(VOICES[base]) return VOICES[base];
  return UNIVERSAL_VOICE;
}

/* =========================
   UI helpers
========================= */
const loadingOverlay = $('loadingOverlay');
const loadingTitle = $('loadingTitle');
const loadingMessage = $('loadingMessage');
const loadingActions = $('loadingActions');

function showLoading(title, message, showActions=false){
  if(title) loadingTitle.textContent = title;
  if(message) loadingMessage.textContent = message;
  loadingActions.classList.toggle('is-hidden', !showActions);
  loadingOverlay.classList.remove('hidden');
}
function hideLoading(){ loadingOverlay.classList.add('hidden'); }

function showToast(m,d=2400){
  const t=$('toast');
  t.textContent=m;
  t.classList.add('show');
  clearTimeout(showToast._t);
  showToast._t=setTimeout(()=>t.classList.remove('show'),d);
}

function generateId(){
  const c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let id='';
  for(let i=0;i<6;i++) id+=c.charAt(Math.floor(Math.random()*c.length));
  return id;
}
function formatTime(s){
  const h=Math.floor(s/3600),m=Math.floor((s%3600)/60),sec=s%60;
  if(h>0)return`${h}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
  return`${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
}
function isMobile(){ return window.innerWidth <= 1024; }

/* =========================
   State
========================= */
let currentUser=null,userProfile=null,currentRoom=null,roomConfig=null;
let userLanguage='en',languagesList=[];
let userRole='student';

let localStream=null,prejoinStream=null;
let selectedMicId=null,selectedCamId=null,selectedSpeakerId=null;
let prejoinMicEnabled=true,prejoinCamEnabled=true;

let participants=new Map();
let teacherUserId=null;
let activeSpeakerUid=null; // single-speaker rule (room meta)

let presenceRef=null,participantsRef=null;
let roomMetaTeacherRef=null,roomMetaSpeakerRef=null;

let meetingStartTime=null,meetingTimerInterval=null;

/* Stream SDK (kept) */
let streamClient=null;
let streamCall=null;
let streamParticipantMap=new Map();

/* Feed / TTS */
let autoPlayTTS=false;
let ttsQueue=[],isPlayingTTS=false,currentAudio=null;
let processedIds=new Set();

/* STT (Teacher) */
let isTranscribing=false,wsDeepgram=null,audioCtx=null,flushTimeout=null,sentenceBuffer='';
let sttSourceMic=null,sttSourceSpeaker=null,sttProcNode=null,sttZeroGain=null;
let sttReconnectTimer=null,sttReconnectAttempt=0,sttStopRequested=false;
const FLUSH_DELAY=1200;

/* Settings overrides */
const SETTINGS_KEY='successclass_settings_v1';
let settings = {
  sttEndpoint: '',
  deepgramKey: '',
  cartesiaKey: '',
  cartesiaModelId: 'sonic-3',
  noise: true,
  echo: true,
  gain: true
};

/* =========================
   Auth
========================= */
auth.onAuthStateChanged(async u=>{
  if(u){
    currentUser=u;
    await loadUserProfile(u);
    await loadLanguages();
    loadLocalSettings();
    hideLoading();
    showPrejoinScreen();
  }else{
    showLoading('Not signed in','Redirecting you to the sign-in page...');
    setTimeout(()=>{window.location.href='auth.html';},600);
  }
});

if(location.protocol === 'file:'){
  showLoading('Local file detected','Open via http://localhost or hosted URL (Firebase auth will not work on file://).',true);
}

async function loadUserProfile(u){
  const snap=await db.ref(`/users/${u.uid}`).once('value');
  let p=snap.val();
  if(!p||!p.personalId){
    const pid=generateId();
    p={name:u.displayName||u.email?.split('@')[0]||'User',email:u.email,personalId:pid,language:'en',createdAt:p?.createdAt||Date.now()};
    if(u.photoURL)p.photoURL=u.photoURL;
    await db.ref(`/users/${u.uid}`).set(p);
  }
  userProfile=p;
  userLanguage=p.language||'en';
}

/* =========================
   Languages
========================= */
async function loadLanguages(){
  try{
    const snap=await db.ref('/languages').once('value');
    const d=snap.val();
    languagesList=[];
    if(d){
      if(Array.isArray(d)) languagesList=d.map(l=>({code:l.code,name:l.name}));
      else for(const[k,v] of Object.entries(d)) languagesList.push({code:v.code||k,name:v.name||v});
    }
    if(!languagesList.length) throw new Error('empty list');
  }catch(e){
    languagesList=[
      {code:'en',name:'English'},
      {code:'tl',name:'Filipino/Tagalog'},
      {code:'tr',name:'Turkish'},
      {code:'nl-BE',name:'Dutch (Belgium)'},
      {code:'fr',name:'French'},
      {code:'de',name:'German'},
      {code:'es',name:'Spanish'}
    ];
  }
  populateLangSelects();
}
function populateLangSelects(){
  const opts=languagesList.map(l=>`<option value="${l.code}">${l.name}</option>`).join('');
  $('userLanguageSelect').innerHTML=opts;
  $('teacherTargetLang').innerHTML=opts;
  $('userLanguageSelect').value=userLanguage || 'en';
  $('teacherTargetLang').value=userLanguage || 'en';
}

/* =========================
   Prejoin
========================= */
$('btnLogout').addEventListener('click',()=>auth.signOut());

$('displayNameInput').addEventListener('input',e=>{
  const val=e.target.value.trim();
  if(val){
    $('prejoinName').textContent=val;
    if(!userProfile?.photoURL && !currentUser?.photoURL){
      $('prejoinAvatar').textContent=val.charAt(0).toUpperCase();
    }
  }
});

$('roomIdInput').addEventListener('input',e=>{e.target.value=e.target.value.toUpperCase().replace(/[^A-Z0-9]/g,'')});
$('btnJoinRoom').addEventListener('click',joinRoom);
$('roomIdInput').addEventListener('keypress',e=>{if(e.key==='Enter')joinRoom()});

$('prejoinMicToggle').addEventListener('click',()=>{
  prejoinMicEnabled=!prejoinMicEnabled;
  $('prejoinMicToggle').classList.toggle('off',!prejoinMicEnabled);
  $('prejoinMicToggle').innerHTML=`<i class="fas fa-microphone${prejoinMicEnabled?'':'-slash'}"></i>`;
  if(prejoinStream) prejoinStream.getAudioTracks().forEach(t=>t.enabled=prejoinMicEnabled);
});
$('prejoinCamToggle').addEventListener('click',()=>{
  prejoinCamEnabled=!prejoinCamEnabled;
  $('prejoinCamToggle').classList.toggle('off',!prejoinCamEnabled);
  $('prejoinCamToggle').innerHTML=`<i class="fas fa-video${prejoinCamEnabled?'':'-slash'}"></i>`;
  $('prejoinVideoOff').classList.toggle('hidden',prejoinCamEnabled);
  if(prejoinStream) prejoinStream.getVideoTracks().forEach(t=>t.enabled=prejoinCamEnabled);
});

$('micSelect').addEventListener('change',startPreviewStream);
$('camSelect').addEventListener('change',startPreviewStream);

async function showPrejoinScreen(){
  $('prejoinOverlay').classList.add('active');
  const name=userProfile?.name||currentUser.displayName||'User';
  $('prejoinName').textContent=name;
  $('prejoinEmail').textContent=userProfile?.email||currentUser.email||'';
  $('displayNameInput').value=name;
  $('prejoinAvatar').textContent=name.charAt(0).toUpperCase();
  if(userProfile?.photoURL||currentUser.photoURL) $('prejoinAvatar').innerHTML=`<img src="${userProfile?.photoURL||currentUser.photoURL}"/>`;
  const p=new URLSearchParams(location.search);
  if(p.get('room')) $('roomIdInput').value=p.get('room').toUpperCase();
  await enumerateDevices();
  await startPreviewStream();
}

async function enumerateDevices(){
  try{
    const devs=await navigator.mediaDevices.enumerateDevices();
    const mics=devs.filter(d=>d.kind==='audioinput'),
          cams=devs.filter(d=>d.kind==='videoinput'),
          spks=devs.filter(d=>d.kind==='audiooutput');

    $('micSelect').innerHTML=mics.map((d,i)=>`<option value="${d.deviceId}">${d.label||('Microphone '+(i+1))}</option>`).join('');
    $('camSelect').innerHTML=cams.map((d,i)=>`<option value="${d.deviceId}">${d.label||('Camera '+(i+1))}</option>`).join('');
    $('speakerSelect').innerHTML=spks.map((d,i)=>`<option value="${d.deviceId}">${d.label||('Speaker '+(i+1))}</option>`).join('');

    $('teacherMicSelect').innerHTML=$('micSelect').innerHTML;
    if(selectedMicId) $('teacherMicSelect').value=selectedMicId;
  }catch(e){
    console.error('enumerateDevices',e);
  }
}

async function startPreviewStream(){
  try{
    prejoinStream?.getTracks()?.forEach(t=>t.stop());
    prejoinStream=await navigator.mediaDevices.getUserMedia({
      video:$('camSelect').value?{deviceId:{exact:$('camSelect').value}}:true,
      audio:$('micSelect').value?{deviceId:{exact:$('micSelect').value}}:true
    });
    $('prejoinVideo').srcObject=prejoinStream;
    $('prejoinVideoOff').classList.add('hidden');
    if(prejoinStream) prejoinStream.getAudioTracks().forEach(t=>t.enabled=prejoinMicEnabled);
    if(prejoinStream) prejoinStream.getVideoTracks().forEach(t=>t.enabled=prejoinCamEnabled);
    await enumerateDevices();
  }catch(e){
    console.error('Preview stream failed:', e);
    $('prejoinVideoOff').classList.remove('hidden');
  }
}

/* =========================
   Join Room
========================= */
async function joinRoom(){
  const rid=$('roomIdInput').value.trim().toUpperCase();
  if(!rid||rid.length<4){showToast('Enter valid room ID');return;}

  const displayName=$('displayNameInput').value.trim();
  if(!displayName){showToast('Enter your display name');return;}

  userRole = $('roleSelect').value || 'student';
  userLanguage = $('userLanguageSelect').value || 'en';

  selectedMicId=$('micSelect').value;
  selectedCamId=$('camSelect').value;
  selectedSpeakerId=$('speakerSelect').value;

  if(displayName!==userProfile?.name){
    await db.ref(`/users/${currentUser.uid}/name`).set(displayName);
    userProfile.name=displayName;
  }
  await db.ref(`/users/${currentUser.uid}/language`).set(userLanguage);

  $('btnJoinRoom').disabled=true;
  $('btnJoinRoom').innerHTML='<i class="fas fa-spinner fa-spin"></i> Joining...';

  try{
    if(rid === 'ORBIT'){
      currentRoom = rid;
      roomConfig = {
        type: 'classroom',
        name: 'Orbit Demo Room',
        deepgramKey: 'dd658e27599a6c7ec1cbe38e2040de6c4533a945',
        cartesiaKey: 'sk_car_gXEk8CgTphxpLVvA1C9DZE',
        cartesiaModelId: 'sonic-3',
        features: { video:true, transcription:true, translation:true }
      };
    } else {
      const snap=await db.ref(`/groups/${rid}`).once('value');
      let cfg=snap.val();
      if(!cfg){
        const ps=await db.ref('/users').orderByChild('personalId').equalTo(rid).once('value');
        if(ps.exists()){
          const ud=Object.values(ps.val())[0];
          cfg={type:'personal',ownerName:ud.name};
          const dc=await db.ref('/groups/DEFAULT').once('value');
          if(dc.val())Object.assign(cfg,dc.val());
        } else {
          showToast('Room not found');
          $('btnJoinRoom').disabled=false;
          $('btnJoinRoom').innerHTML='<i class="fas fa-sign-in-alt"></i> Join Class';
          return;
        }
      }
      currentRoom=rid;
      roomConfig=cfg;
    }

    // settings overrides
    applySettingsToRoomConfig();

    history.replaceState({},'',`${location.pathname}?room=${rid}`);

    prejoinStream?.getTracks()?.forEach(t=>t.stop());
    prejoinStream=null;

    $('prejoinOverlay').classList.remove('active');
    $('appContainer').classList.add('active');

    await initRoom();

  }catch(e){
    console.error('Join room error:', e);
    showToast('Failed to join room: ' + e.message);
  }

  $('btnJoinRoom').disabled=false;
  $('btnJoinRoom').innerHTML='<i class="fas fa-sign-in-alt"></i> Join Class';
}

async function initRoom(){
  try{
    $('displayRoomId').textContent=currentRoom;
    $('roleChip').textContent = `Role: ${userRole.toUpperCase()}`;
    $('brandSubtitle').textContent = roomConfig?.name || 'Real-time multilingual classroom';

    meetingStartTime=Date.now();
    meetingTimerInterval=setInterval(updateMeetingTimer,1000);

    // Local capture
    const noise = settings.noise;
    const echo = settings.echo;
    const gain = settings.gain;

    localStream=await navigator.mediaDevices.getUserMedia({
      video: selectedCamId ? {deviceId:{exact:selectedCamId}} : true,
      audio: {
        deviceId: selectedMicId ? {exact:selectedMicId} : undefined,
        echoCancellation: echo,
        noiseSuppression: noise,
        autoGainControl: gain
      }
    });

    // enforce role behavior
    if(userRole === 'student'){
      // students default muted regardless of prejoin toggles
      localStream.getAudioTracks().forEach(t=>t.enabled=false);
      prejoinMicEnabled=false;
    } else {
      localStream.getAudioTracks().forEach(t=>t.enabled=prejoinMicEnabled);
    }
    localStream.getVideoTracks().forEach(t=>t.enabled=prejoinCamEnabled);

    // bind teacher tile video:
    bindTeacherTileVideoLocalIfTeacher();

    // presence + meta
    await registerPresence();
    listenToRoomMeta();
    listenToParticipants();
    listenToSpeakerGateForSelf();
    listenToTranscripts();

    // connect Stream (kept) for remote audio/video (teacher tile can show teacher video for students)
    await initStreamVideo();

    // for students: show teacher video in teacher tile when available
    if(userRole === 'student'){
      setTimeout(()=>attachTeacherRemoteVideoIfPossible(), 600);
    }

    // teacher controls visible only for teacher
    $('teacherControls').classList.toggle('hidden', userRole !== 'teacher');
    $('teacherSub').textContent = (userRole === 'teacher') ? 'Operator' : 'Viewer';

    // console defaults
    $('btnStopSTT').disabled = true;
    $('btnStartSTT').disabled = (userRole !== 'teacher');

    // dot states initial
    setConnState('Idle','warn');
    setMicState(localStream.getAudioTracks()?.[0]?.enabled ? 'Live' : 'Muted', localStream.getAudioTracks()?.[0]?.enabled ? 'ok' : 'warn');
    $('liveBadge').textContent='IDLE';
    $('liveBadge').classList.remove('live');

    updateParticipantsUI();
    showToast('Joined ' + currentRoom);

    // teacher: auto start STT
    if(userRole === 'teacher'){
      // set active speaker default = teacher
      await db.ref(`/rooms/${currentRoom}/meta/activeSpeakerUid`).transaction(cur => cur || currentUser.uid);
      // start STT only if feature enabled + key present
      if(roomConfig?.deepgramKey && roomConfig?.features?.transcription){
        startTranscription();
      }
    }

    $('teacherAutoTts').value = autoPlayTTS ? 'on' : 'off';
    $('teacherAutoTts').addEventListener('change', ()=>{
      autoPlayTTS = ($('teacherAutoTts').value === 'on');
      showToast(autoPlayTTS ? 'Auto-play TTS enabled' : 'Auto-play TTS disabled');
    });

  }catch(e){
    console.error('Room init error', e);
    showToast('Room setup failed: ' + e.message);
  }
}

function updateMeetingTimer(){
  const e=Math.floor((Date.now()-meetingStartTime)/1000);
  const d=formatTime(e);
  $('timerDisplay').textContent=d;
}

function setConnState(label, mode='warn'){
  $('connState').textContent=label;
  const dot=$('connDot');
  dot.classList.remove('ok','warn','live');
  dot.classList.add(mode==='ok'?'ok':mode==='live'?'live':'warn');
}
function setMicState(label, mode='warn'){
  $('micState').textContent=label;
  const dot=$('micDot');
  dot.classList.remove('ok','warn','live');
  dot.classList.add(mode==='ok'?'ok':mode==='live'?'live':'warn');
}
function setRoomDot(mode='warn'){
  const dot=$('roomDot');
  dot.classList.remove('ok','warn','live');
  dot.classList.add(mode==='ok'?'ok':mode==='live'?'live':'warn');
}

/* =========================
   Presence + Roles + Meta
========================= */
async function registerPresence(){
  if(!currentRoom||!currentUser) return;

  presenceRef=db.ref(`/rooms/${currentRoom}/participants/${currentUser.uid}`);

  const userData={
    uid:currentUser.uid,
    name:userProfile?.name||currentUser.displayName||'User',
    email:userProfile?.email||currentUser.email||'',
    photoURL:userProfile?.photoURL||currentUser.photoURL||'',
    language:userLanguage,
    role:userRole,
    micEnabled: localStream?.getAudioTracks?.()[0]?.enabled ?? false,
    camEnabled: localStream?.getVideoTracks?.()[0]?.enabled ?? false,
    handRaised:false,
    allowedToSpeak: (userRole==='teacher') ? true : false,
    joinedAt:firebase.database.ServerValue.TIMESTAMP,
    lastSeen:firebase.database.ServerValue.TIMESTAMP
  };

  await presenceRef.set(userData);
  presenceRef.onDisconnect().remove();

  setInterval(()=>{
    if(presenceRef) presenceRef.child('lastSeen').set(firebase.database.ServerValue.TIMESTAMP);
  },30000);

  // teacher election: only a real teacher role can claim teacherUid if empty
  if(userRole === 'teacher'){
    await ensureTeacherRole();
  }

  setRoomDot('ok');
}

async function ensureTeacherRole(){
  const teacherUidRef = db.ref(`/rooms/${currentRoom}/meta/teacherUid`);
  const teacherNameRef = db.ref(`/rooms/${currentRoom}/meta/teacherName`);
  try{
    const res = await teacherUidRef.transaction(cur => cur || currentUser.uid);
    teacherUserId = res?.snapshot?.val() || currentUser.uid;
    const myName = userProfile?.name || currentUser.displayName || currentUser.email?.split('@')[0] || 'Teacher';
    await teacherNameRef.transaction(cur => cur || myName);
  }catch(e){
    console.warn('ensureTeacherRole failed:', e);
  }
}

function listenToRoomMeta(){
  if(!currentRoom) return;

  try{ roomMetaTeacherRef?.off(); }catch{}
  roomMetaTeacherRef = db.ref(`/rooms/${currentRoom}/meta/teacherUid`);
  roomMetaTeacherRef.on('value', snap=>{
    teacherUserId = snap.val() || teacherUserId;
    updateParticipantsUI();
    if(userRole==='student'){
      attachTeacherRemoteVideoIfPossible();
    }
  });

  try{ roomMetaSpeakerRef?.off(); }catch{}
  roomMetaSpeakerRef = db.ref(`/rooms/${currentRoom}/meta/activeSpeakerUid`);
  roomMetaSpeakerRef.on('value', snap=>{
    activeSpeakerUid = snap.val() || null;
    updateParticipantsUI();
    // if teacher, rebuild stt pipeline to include current speaker remote audio
    if(userRole==='teacher' && isTranscribing){
      rebuildSttSourcesForActiveSpeaker().catch(()=>{});
    }
  });
}

function listenToParticipants(){
  if(!currentRoom) return;

  participantsRef=db.ref(`/rooms/${currentRoom}/participants`);

  participantsRef.on('value', snap=>{
    const obj = snap.val() || {};
    participants.clear();
    for(const [uid,p] of Object.entries(obj)){
      if(!p) continue;
      participants.set(uid, p);
    }
    setRoomDot('ok');
    updateParticipantsUI();
  });
}

function updateParticipantsUI(){
  $('participantCount').textContent = participants.size || 1;

  // teacher badge
  const badge = $('liveBadge');
  if(userRole==='teacher' && isTranscribing){
    badge.textContent='LIVE';
    badge.classList.add('live');
  } else {
    badge.textContent = (userRole==='teacher') ? 'IDLE' : 'VIEW';
    badge.classList.remove('live');
  }

  // students panels (desktop + mobile)
  renderStudentsInto($('studentsScroll'));
  renderQueueInto($('queueList'), $('queueCount'), $('queueEmpty'));

  renderStudentsInto($('studentsScrollMobile'), true);
  renderQueueInto($('queueListMobile'), $('queueCountMobile'), null, true);

  // show empty state on desktop if needed
  const hasAny = participants.size > 0;
  $('studentsEmpty')?.style && ($('studentsEmpty').style.display = hasAny ? 'none' : 'flex');
}

function renderStudentsInto(container, mobile=false){
  if(!container) return;
  container.innerHTML = '';

  // order: teacher first, then everyone else by joinedAt
  const entries = Array.from(participants.entries()).map(([uid,p])=>({uid,p}));
  entries.sort((a,b)=>(Number(a.p?.joinedAt)||0)-(Number(b.p?.joinedAt)||0));

  // move teacher to top if exists
  entries.sort((a,b)=>{
    if(a.uid===teacherUserId) return -1;
    if(b.uid===teacherUserId) return 1;
    return 0;
  });

  for(const it of entries){
    const uid = it.uid;
    const p = it.p || {};
    const name = p.name || 'User';
    const ini = name.charAt(0).toUpperCase();
    const isTeacher = (uid === teacherUserId);
    const isSpeaker = (uid && activeSpeakerUid && uid === activeSpeakerUid);
    const hand = !!p.handRaised;
    const micEnabled = !!p.micEnabled;
    const allowed = !!p.allowedToSpeak;

    const card = document.createElement('div');
    card.className = 'student-card';
    const ava = p.photoURL
      ? `<img src="${p.photoURL}" alt=""/>`
      : `${ini}`;

    const tags = [
      isTeacher ? `<span class="tag teacher">TEACHER</span>` : '',
      isSpeaker ? `<span class="tag speaker">SPEAKING</span>` : '',
      hand ? `<span class="tag hand">HAND</span>` : ''
    ].join('');

    const micDot = micEnabled ? `<span class="mini-dot"></span>` : `<span class="mini-dot muted"></span>`;
    const sub = `${micEnabled ? 'Mic on' : 'Muted'} • ${allowed ? 'Allowed' : 'Blocked'}`;

    // teacher-only actions for student cards
    const canManage = (userRole === 'teacher') && !isTeacher;

    card.innerHTML = `
      <div class="student-ava">${ava}</div>
      <div class="student-info">
        <div class="name">${escapeHtml(name)} ${tags}</div>
        <div class="sub">${micDot}<span>${escapeHtml(sub)}</span></div>
      </div>
      <div class="student-actions" style="${canManage ? '' : 'display:none'}">
        <button class="sbtn accept" title="Accept (allow to speak)" data-accept="${uid}"><i class="fas fa-check"></i></button>
        <button class="sbtn reject" title="Reject / Mute" data-reject="${uid}"><i class="fas fa-times"></i></button>
      </div>
    `;

    if(canManage){
      card.querySelector(`[data-accept="${uid}"]`)?.addEventListener('click', ()=>acceptSpeaker(uid));
      card.querySelector(`[data-reject="${uid}"]`)?.addEventListener('click', ()=>rejectSpeaker(uid));
    }

    container.appendChild(card);
  }
}

function renderQueueInto(container, badgeEl, emptyEl=null, mobile=false){
  if(!container) return;
  container.innerHTML = '';

  const raised = Array.from(participants.entries())
    .filter(([uid,p])=>p && p.role==='student' && p.handRaised)
    .map(([uid,p])=>({uid,p}))
    .sort((a,b)=>(Number(a.p?.joinedAt)||0)-(Number(b.p?.joinedAt)||0));

  if(badgeEl) badgeEl.textContent = raised.length;

  if(!raised.length){
    if(emptyEl) emptyEl.style.display='block';
    if(!emptyEl){
      const d=document.createElement('div');
      d.className='queue-empty';
      d.textContent='No raised hands.';
      container.appendChild(d);
    }
    return;
  }
  if(emptyEl) emptyEl.style.display='none';

  for(const r of raised){
    const uid=r.uid;
    const p=r.p||{};
    const name=p.name||'Student';
    const lang=p.language||'en';

    const row=document.createElement('div');
    row.className='queue-item';
    const canManage = (userRole==='teacher');

    row.innerHTML=`
      <div class="who">
        ${escapeHtml(name)}
        <small>Wants to speak • ${escapeHtml(lang)}</small>
      </div>
      <div class="queue-actions" style="${canManage?'':'display:none'}">
        <button class="sbtn accept" title="Accept" data-qaccept="${uid}"><i class="fas fa-check"></i></button>
        <button class="sbtn reject" title="Reject" data-qreject="${uid}"><i class="fas fa-times"></i></button>
      </div>
    `;
    if(canManage){
      row.querySelector(`[data-qaccept="${uid}"]`)?.addEventListener('click',()=>acceptSpeaker(uid));
      row.querySelector(`[data-qreject="${uid}"]`)?.addEventListener('click',()=>rejectSpeaker(uid));
    }
    container.appendChild(row);
  }
}

async function acceptSpeaker(uid){
  if(userRole!=='teacher' || !currentRoom) return;
  try{
    // enforce single-speaker:
    const updates = {};
    for(const [id,p] of participants){
      if(!p) continue;
      if(p.role==='student'){
        updates[`/rooms/${currentRoom}/participants/${id}/allowedToSpeak`] = (id === uid);
        updates[`/rooms/${currentRoom}/participants/${id}/handRaised`] = false;
      }
    }
    // teacher always allowed
    updates[`/rooms/${currentRoom}/participants/${teacherUserId || currentUser.uid}/allowedToSpeak`] = true;
    // set active speaker meta:
    updates[`/rooms/${currentRoom}/meta/activeSpeakerUid`] = uid;

    await db.ref().update(updates);
    showToast('Accepted speaker');
  }catch(e){
    console.error('acceptSpeaker', e);
    showToast('Accept failed');
  }
}

async function rejectSpeaker(uid){
  if(userRole!=='teacher' || !currentRoom) return;
  try{
    const updates = {};
    updates[`/rooms/${currentRoom}/participants/${uid}/allowedToSpeak`] = false;
    updates[`/rooms/${currentRoom}/participants/${uid}/handRaised`] = false;

    // if rejecting current active speaker, revert to teacher
    if(activeSpeakerUid === uid){
      updates[`/rooms/${currentRoom}/meta/activeSpeakerUid`] = (teacherUserId || currentUser.uid);
    }
    await db.ref().update(updates);
    showToast('Speaker blocked');
  }catch(e){
    console.error('rejectSpeaker', e);
    showToast('Reject failed');
  }
}

function listenToSpeakerGateForSelf(){
  if(!currentRoom || !currentUser) return;
  db.ref(`/rooms/${currentRoom}/participants/${currentUser.uid}/allowedToSpeak`).on('value', snap=>{
    const allowed = !!snap.val();
    if(userRole==='student'){
      const track = localStream?.getAudioTracks?.()[0];
      if(track){
        track.enabled = allowed;
        setMicState(allowed ? 'Live' : 'Muted', allowed ? 'ok' : 'warn');
        // update presence micEnabled accordingly
        presenceRef?.child('micEnabled')?.set(allowed);
      }
    }
  });
}

/* =========================
   Teacher Tile Video
========================= */
function bindTeacherTileVideoLocalIfTeacher(){
  const v = $('teacherVideo');
  const ph = $('teacherVideoPlaceholder');
  if(!v) return;

  // teacher sees own local; student sees teacher remote when available
  if(userRole === 'teacher'){
    v.muted = true;
    if(localStream){
      v.srcObject = localStream;
      ph.style.display='none';
      v.play().catch(()=>{});
    } else {
      ph.style.display='flex';
    }
  } else {
    // student: placeholder until teacher remote attaches
    v.muted = false;
    ph.style.display='flex';
  }
}

function attachTeacherRemoteVideoIfPossible(){
  if(userRole !== 'student') return;
  if(!teacherUserId) return;

  const v=$('teacherVideo');
  const ph=$('teacherVideoPlaceholder');
  if(!v) return;

  // try Stream participant (if joined)
  const p = streamParticipantMap.get(teacherUserId);
  if(!p) return;

  try{
    const videoTrack = p.videoTrack;
    if(videoTrack){
      v.srcObject = new MediaStream([videoTrack]);
      ph.style.display='none';
      v.play().catch(()=>{});
    }
  }catch(e){
    console.warn('attachTeacherRemoteVideoIfPossible', e);
  }
}

/* =========================
   Stream Token + Video (kept)
========================= */
async function generateStreamToken(userId, userName) {
  const expiresIn = USER_TOKEN_EXPIRY_HOURS * 3600;
  const now = Math.floor(Date.now() / 1000);
  const exp = now + expiresIn;
  const payload = { user_id:userId, user_name:userName, exp, api_key:STREAM_API_KEY };
  const encodedPayload = btoa(JSON.stringify(payload));
  return `demo_${encodedPayload}`;
}

async function initStreamVideo() {
  try {
    if (!window.StreamVideo) {
      showToast('Video library not loaded (limited mode)');
      return;
    }

    const userName = userProfile?.name || currentUser?.displayName || 'User';
    const userId = currentUser?.uid || `user_${Date.now()}`;
    const token = await generateStreamToken(userId, userName);

    streamClient = new StreamVideo({
      apiKey: STREAM_API_KEY,
      token,
      user: { id:userId, name:userName, image:userProfile?.photoURL || currentUser?.photoURL || '' },
      options: { logLevel:'info', timeout:10000 }
    });

    streamCall = streamClient.call('default', currentRoom);

    streamCall.on('participant.joined', (event)=> handleStreamParticipantJoined(event.participant));
    streamCall.on('participant.left', (event)=>{
      const pid = event.participant?.user?.id;
      if(pid){
        streamParticipantMap.delete(pid);
        if(pid === teacherUserId && userRole==='student'){
          $('teacherVideoPlaceholder').style.display='flex';
        }
      }
    });
    streamCall.on('participant.updated', (event)=> handleStreamParticipantUpdated(event.participant));
    streamCall.on('track.started', (event)=> handleStreamParticipantUpdated(event.participant));
    streamCall.on('track.stopped', (event)=> handleStreamParticipantUpdated(event.participant));
    streamCall.on('error', (error)=> { console.error('Stream error:', error); });

    await streamCall.join({
      create:true,
      data:{ custom:{ title:`Classroom: ${currentRoom}`, description:'Real-time multilingual classroom', language:userLanguage } }
    });

    streamParticipantMap.set(currentUser.uid, streamCall.state.localParticipant);

    const existingParticipants = streamCall.state.participants || [];
    existingParticipants.forEach(p=>{
      if(p?.user?.id && p.user.id !== currentUser.uid) handleStreamParticipantJoined(p);
    });

    // after join, attempt attach teacher remote
    if(userRole==='student'){
      attachTeacherRemoteVideoIfPossible();
    }
  } catch(e) {
    console.error('Stream init error:', e);
  }
}

function handleStreamParticipantJoined(participant) {
  if(!participant || participant.user.id === currentUser.uid) return;
  streamParticipantMap.set(participant.user.id, participant);
  // if joining participant is teacher, attach
  if(userRole==='student' && participant.user.id === teacherUserId){
    attachTeacherRemoteVideoIfPossible();
  }
}

function handleStreamParticipantUpdated(participant) {
  if(!participant) return;
  streamParticipantMap.set(participant.user.id, participant);
  if(userRole==='student' && participant.user.id === teacherUserId){
    attachTeacherRemoteVideoIfPossible();
  }
}

async function leaveStreamCall() {
  if(streamCall){
    try{ await streamCall.leave(); }catch(e){ console.error('leave call:', e); }
    streamCall = null;
  }
  if(streamClient){
    try{ await streamClient.disconnectUser(); }catch(e){ console.error('disconnect:', e); }
    streamClient = null;
  }
  streamParticipantMap.clear();
}

/* =========================
   Raise Hand (Student)
========================= */
let handRaised=false;
async function toggleRaiseHand(){
  if(!currentRoom || !currentUser) return;
  if(userRole !== 'student'){
    showToast('Teacher does not need raise-hand');
    return;
  }
  handRaised = !handRaised;
  await db.ref(`/rooms/${currentRoom}/participants/${currentUser.uid}/handRaised`).set(handRaised);
  showToast(handRaised ? 'Hand raised' : 'Hand lowered');
}

/* =========================
   Feed + Translation + TTS
========================= */
function resetFeed(){
  processedIds = new Set();
  $('feedScroll').innerHTML = `
    <div class="feed-empty" id="feedEmpty">
      <i class="fas fa-language"></i>
      <div style="font-weight:900;margin-bottom:6px">Waiting for speech…</div>
      <div style="max-width:360px">Transcripts and translations will appear here as the teacher (or the allowed student) speaks.</div>
    </div>
  `;
}

$('btnClearFeed').addEventListener('click', ()=>{
  if(confirm('Clear feed?')){
    resetFeed();
    showToast('Feed cleared');
  }
});

$('btnCopyFeed').addEventListener('click', async ()=>{
  try{
    const lines=[];
    const items = Array.from(document.querySelectorAll('.feed-item'));
    for(const it of items){
      const name = it.getAttribute('data-name')||'';
      const time = it.getAttribute('data-time')||'';
      const src = it.querySelector('.source')?.textContent || '';
      const trn = it.querySelector('.translation')?.textContent || '';
      lines.push(`[${time}] ${name}\nSRC: ${src}\nTRN: ${trn}\n`);
    }
    await navigator.clipboard.writeText(lines.join('\n'));
    showToast('Copied feed');
  }catch(e){
    showToast('Copy failed');
  }
});

$('btnSendTest').addEventListener('click', sendTestComposer);
$('testComposerInput').addEventListener('keypress', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); sendTestComposer(); } });

async function sendTestComposer(){
  const v = $('testComposerInput').value.trim();
  if(!v) return;
  $('testComposerInput').value='';
  // send as transcript item (teacher-like)
  await sendTranscript(v, {forceSpeakerUid: currentUser.uid, forceSpeakerName: userProfile?.name || 'You', forceRole: userRole});
}

async function googleTranslate(t,sl='auto',tl='en'){
  const q=encodeURIComponent(t);
  const r=await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sl}&tl=${tl}&dt=t&q=${q}`);
  if(!r.ok) throw new Error(`Trans ${r.status}`);
  const d=await r.json();
  return (d?.[0]||[]).filter(x=>Array.isArray(x)&&typeof x[0]==='string').map(x=>x[0]).join('').trim();
}

function listenToTranscripts(){
  if(!currentRoom) return;
  resetFeed();

  db.ref(`/transcripts/${currentRoom}`)
    .orderByChild('timestamp')
    .limitToLast(250)
    .on('child_added', async snap=>{
      const e=snap.val();
      if(!e) return;
      if(!e.id) e.id=snap.key;
      if(processedIds.has(e.id)) return;
      processedIds.add(e.id);

      let tran=e.originalText;
      try{ tran = await googleTranslate(e.originalText,'auto',userLanguage); }catch(_){}

      addFeedItem({
        id:e.id,
        userId:e.userId,
        userName:e.userName || 'User',
        role:e.role || 'speaker',
        originalText:e.originalText,
        translation:tran,
        timestamp:e.timestamp || Date.now()
      });

      if(autoPlayTTS){
        queueTTS({id:e.id,text:tran,lang:userLanguage});
      }
    });
}

function addFeedItem(e){
  const empty=$('feedEmpty');
  if(empty) empty.remove();

  const time = new Date(e.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  const ini = (e.userName||'U').charAt(0).toUpperCase();

  const item=document.createElement('div');
  item.className='feed-item';
  item.dataset.id=e.id;
  item.setAttribute('data-name', e.userName||'User');
  item.setAttribute('data-time', time);

  item.innerHTML=`
    <div class="feed-top">
      <div class="avatar">${ini}</div>
      <div class="feed-meta">
        <div class="feed-name">${escapeHtml(e.userName||'User')}</div>
        <div class="feed-time">${time}</div>
      </div>
      <div style="margin-left:auto;display:flex;gap:6px;align-items:center">
        ${e.role==='teacher'?`<span class="tag teacher">TEACHER</span>`:''}
        ${(activeSpeakerUid && e.userId===activeSpeakerUid && userRole==='teacher')?`<span class="tag speaker">ACTIVE</span>`:''}
      </div>
    </div>
    <div class="feed-bodyline">
      <div class="source">${escapeHtml(e.originalText||'')}</div>
      <div class="translation">${escapeHtml(e.translation||'')}</div>
    </div>
    <div class="feed-actions">
      <button class="pill-btn" data-play="${e.id}" data-text="${encodeURIComponent(e.translation||'')}"><i class="fas fa-volume-up"></i> Play</button>
    </div>
  `;

  $('feedScroll').appendChild(item);
  $('feedScroll').scrollTop = $('feedScroll').scrollHeight;

  item.querySelector(`[data-play="${e.id}"]`)?.addEventListener('click', async (ev)=>{
    const btn=ev.currentTarget;
    const txt=decodeURIComponent(btn.dataset.text||'');
    if(!txt) return;
    btn.classList.add('playing');
    try{ await playTTSAudio(txt, userLanguage); }catch(_){}
    btn.classList.remove('playing');
  });
}

/* TTS queue */
function queueTTS(i){ ttsQueue.push(i); processTTSQueue(); }
async function processTTSQueue(){
  if(isPlayingTTS||ttsQueue.length===0) return;
  isPlayingTTS=true;
  const i=ttsQueue.shift();
  try{ await playTTSAudio(i.text,i.lang); }catch(_){}
  isPlayingTTS=false;
  if(ttsQueue.length>0) processTTSQueue();
}
async function playTTSAudio(txt,lang){
  return new Promise(async(res,rej)=>{
    const vid=getVoice(lang);
    try{
      const key = roomConfig?.cartesiaKey;
      if(!key) throw new Error('Missing Cartesia key');
      const r=await fetch('https://api.cartesia.ai/tts/bytes',{
        method:'POST',
        headers:{
          'Cartesia-Version':'2025-04-16',
          'X-API-Key':key,
          'Content-Type':'application/json'
        },
        body:JSON.stringify({
          transcript:txt,
          model_id:roomConfig.cartesiaModelId||'sonic-3',
          voice:{mode:'id',id:vid},
          output_format:{container:'wav',encoding:'pcm_f32le',sample_rate:44100}
        })
      });
      if(!r.ok) throw new Error(`TTS ${r.status}`);
      const blob=await r.blob(), url=URL.createObjectURL(blob);
      if(currentAudio){ currentAudio.pause(); currentAudio=null; }
      const a=new Audio(url); currentAudio=a;
      if(selectedSpeakerId && a.setSinkId) try{ await a.setSinkId(selectedSpeakerId); }catch(_){}
      a.onended=()=>{ currentAudio=null; URL.revokeObjectURL(url); res(); };
      a.onerror=(e)=>{ currentAudio=null; URL.revokeObjectURL(url); rej(e); };
      await a.play();
    }catch(e){ rej(e); }
  });
}

/* =========================
   STT (Teacher) - Deepgram, with mixed mic + active speaker audio
========================= */
function defaultDeepgramUrl(){
  return (
    'wss://api.deepgram.com/v1/listen' +
    '?endpointing=false' +
    '&interim_results=true' +
    '&punctuate=true' +
    '&smart_format=true' +
    '&vad_events=true' +
    '&language=multi' +
    '&model=nova-3' +
    '&encoding=linear16' +
    '&sample_rate=16000'
  );
}

function getDeepgramKey(){
  return roomConfig?.deepgramKey || '';
}

function cleanupSttNodes(){
  try{ sttProcNode?.disconnect(); }catch(_){}
  try{ sttSourceMic?.disconnect(); }catch(_){}
  try{ sttSourceSpeaker?.disconnect(); }catch(_){}
  try{ sttZeroGain?.disconnect(); }catch(_){}
  sttProcNode=null;
  sttSourceMic=null;
  sttSourceSpeaker=null;
  sttZeroGain=null;
}

function scheduleSttReconnect(reason){
  if(sttStopRequested) return;
  if(userRole!=='teacher') return;
  if(!roomConfig?.deepgramKey) return;
  if(sttReconnectTimer) return;

  const base=900;
  const delay=Math.min(30000, base * Math.pow(2, sttReconnectAttempt));
  sttReconnectAttempt = Math.min(sttReconnectAttempt + 1, 6);

  sttReconnectTimer=setTimeout(()=>{
    sttReconnectTimer=null;
    if(!sttStopRequested && !isTranscribing){
      console.log('STT reconnect', reason, 'attempt', sttReconnectAttempt);
      startTranscription();
    }
  }, delay);
}

function startTranscription(){
  if(userRole!=='teacher') return;
  if(isTranscribing) return;
  if(!getDeepgramKey()) { showToast('Missing Deepgram key'); return; }
  if(!localStream) { showToast('No local mic'); return; }

  const audioTrack = localStream.getAudioTracks?.()[0];
  if(!audioTrack){ showToast('No microphone available'); return; }

  sttStopRequested=false;
  isTranscribing=true;
  sentenceBuffer='';

  $('btnStartSTT').disabled=true;
  $('btnStopSTT').disabled=false;

  setConnState('Connecting…','warn');
  setRoomDot('live');
  $('liveBadge').textContent='LIVE';
  $('liveBadge').classList.add('live');

  const dgUrl = settings.sttEndpoint?.trim() || defaultDeepgramUrl();
  const key = getDeepgramKey();

  try{
    wsDeepgram = new WebSocket(dgUrl, ['token', key]);
  }catch(e){
    console.error('STT WS create failed', e);
    isTranscribing=false;
    $('btnStartSTT').disabled=false;
    $('btnStopSTT').disabled=true;
    setConnState('Failed','warn');
    scheduleSttReconnect('ws-create-failed');
    return;
  }

  wsDeepgram.binaryType='arraybuffer';

  wsDeepgram.onopen = async ()=>{
    sttReconnectAttempt=0;
    setConnState('Connected','ok');
    try{
      await setupAudioPipelineMixed();
    }catch(e){
      console.error('STT pipeline failed', e);
      stopTranscription(true);
      scheduleSttReconnect('pipeline-failed');
    }
  };

  wsDeepgram.onmessage = handleTranscript;

  wsDeepgram.onerror = (e)=>{
    console.error('STT error', e);
    setConnState('Error','warn');
  };

  wsDeepgram.onclose = ()=>{
    isTranscribing=false;
    cleanupSttNodes();
    try{ audioCtx?.close(); }catch(_){}
    audioCtx=null;
    wsDeepgram=null;

    $('btnStartSTT').disabled = false;
    $('btnStopSTT').disabled = true;

    setConnState('Disconnected','warn');
    setRoomDot('warn');
    $('liveBadge').textContent='IDLE';
    $('liveBadge').classList.remove('live');

    if(!sttStopRequested) scheduleSttReconnect('ws-closed');
  };
}

function stopTranscription(noFlush=false){
  sttStopRequested=true;
  isTranscribing=false;

  $('btnStartSTT').disabled = (userRole!=='teacher');
  $('btnStopSTT').disabled = true;

  if(sttReconnectTimer){ clearTimeout(sttReconnectTimer); sttReconnectTimer=null; }
  if(flushTimeout){ clearTimeout(flushTimeout); flushTimeout=null; }

  if(!noFlush && sentenceBuffer){
    sendTranscript(sentenceBuffer, {forceSpeakerUid: activeSpeakerUid || currentUser.uid}).catch(()=>{});
    sentenceBuffer='';
  }

  try{ wsDeepgram?.close(); }catch(_){}
  wsDeepgram=null;

  cleanupSttNodes();
  try{ audioCtx?.close(); }catch(_){}
  audioCtx=null;

  setConnState('Idle','warn');
  setRoomDot('ok');
  $('liveBadge').textContent = (userRole==='teacher') ? 'IDLE' : 'VIEW';
  $('liveBadge').classList.remove('live');
}

async function rebuildSttSourcesForActiveSpeaker(){
  // rebuild audio nodes without restarting websocket
  if(!audioCtx || !sttProcNode) return;
  cleanupSttNodes();
  await setupAudioPipelineMixed();
}

async function setupAudioPipelineMixed(){
  if(!localStream) throw new Error('no-localStream');
  const track = localStream.getAudioTracks?.()[0];
  if(!track) throw new Error('no-audioTrack');

  audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)({latencyHint:'interactive'});
  await audioCtx.resume().catch(()=>{});

  // mic source
  const micStream = new MediaStream([track]);
  sttSourceMic = audioCtx.createMediaStreamSource(micStream);

  // script processor
  sttProcNode = audioCtx.createScriptProcessor(2048,1,1);

  // zero gain to avoid audible loop
  sttZeroGain = audioCtx.createGain();
  sttZeroGain.gain.value = 0;

  // connect mic -> proc
  sttSourceMic.connect(sttProcNode);

  // optional active speaker remote audio -> proc (mixed)
  sttSourceSpeaker = null;
  if(activeSpeakerUid && activeSpeakerUid !== currentUser.uid){
    const remote = streamParticipantMap.get(activeSpeakerUid);
    const audioTrack = remote?.audioTrack;
    if(audioTrack){
      const spStream = new MediaStream([audioTrack]);
      sttSourceSpeaker = audioCtx.createMediaStreamSource(spStream);
      sttSourceSpeaker.connect(sttProcNode);
    }
  }

  sttProcNode.connect(sttZeroGain);
  sttZeroGain.connect(audioCtx.destination);

  sttProcNode.onaudioprocess = (e)=>{
    if(!wsDeepgram || wsDeepgram.readyState!==1) return;
    if(sttStopRequested) return;
    const f32 = e.inputBuffer.getChannelData(0);
    const pcm16 = downsample(f32, audioCtx.sampleRate, 16000);
    wsDeepgram.send(pcm16.buffer);
  };
}

function downsample(f32, inR, outR){
  if(outR === inR){
    const out = new Int16Array(f32.length);
    for(let i=0;i<f32.length;i++){
      const s = Math.max(-1, Math.min(1, f32[i]));
      out[i] = s < 0 ? s*0x8000 : s*0x7FFF;
    }
    return out;
  }
  const ratio = inR / outR;
  const newLen = Math.floor(f32.length / ratio);
  const out = new Int16Array(newLen);
  for(let i=0;i<newLen;i++){
    const idx = Math.floor(i * ratio);
    const s = Math.max(-1, Math.min(1, f32[idx]));
    out[i] = s < 0 ? s*0x8000 : s*0x7FFF;
  }
  return out;
}

function handleTranscript(e){
  let d;
  try{ d = JSON.parse(e.data); }catch(_){ return; }
  const alt = d.channel?.alternatives?.[0];
  const tr = (alt?.transcript || '').trim();
  if(!tr) return;

  const isFinal = Boolean(d.is_final || d.speech_final);
  if(!isFinal) return;

  sentenceBuffer = (sentenceBuffer ? (sentenceBuffer + ' ' + tr) : tr).replace(/\s+/g,' ').trim();

  if(flushTimeout) clearTimeout(flushTimeout);

  const fastFlush = Boolean(d.speech_final || d.type === 'UtteranceEnd');
  const delay = fastFlush ? 300 : FLUSH_DELAY;

  flushTimeout=setTimeout(()=>{
    if(sentenceBuffer){
      sendTranscript(sentenceBuffer, {forceSpeakerUid: activeSpeakerUid || currentUser.uid}).catch(()=>{});
      sentenceBuffer='';
    }
  }, delay);
}

async function sendTranscript(txt, meta={}){
  const clean=(txt||'').trim();
  if(!clean || !currentRoom) return;

  const speakerUid = meta.forceSpeakerUid || currentUser.uid;
  const speaker = participants.get(speakerUid) || {};
  const speakerName = meta.forceSpeakerName || speaker.name || (speakerUid===currentUser.uid ? (userProfile?.name||'User') : 'Speaker');
  const role = speaker.role || meta.forceRole || (speakerUid===teacherUserId ? 'teacher' : 'student');

  const ref = db.ref(`/transcripts/${currentRoom}`).push();
  const eid = ref.key;

  await ref.set({
    id:eid,
    userId:speakerUid,
    userName:speakerName,
    role,
    originalText:clean,
    originalLang:'auto',
    timestamp:Date.now()
  });
}

/* =========================
   Teacher controls wiring
========================= */
$('btnStartSTT').addEventListener('click', ()=>{
  if(userRole!=='teacher'){ showToast('Only teacher can start'); return; }
  startTranscription();
});
$('btnStopSTT').addEventListener('click', ()=>{
  if(userRole!=='teacher') return;
  stopTranscription();
});

$('teacherMicSelect').addEventListener('change', async ()=>{
  selectedMicId = $('teacherMicSelect').value;
  if(!localStream) return;
  // restart mic capture
  try{
    localStream.getTracks().forEach(t=>t.stop());
    localStream = await navigator.mediaDevices.getUserMedia({
      video: selectedCamId ? {deviceId:{exact:selectedCamId}} : true,
      audio: {
        deviceId: selectedMicId ? {exact:selectedMicId} : undefined,
        echoCancellation: settings.echo,
        noiseSuppression: settings.noise,
        autoGainControl: settings.gain
      }
    });
    // role enforcement
    if(userRole==='student'){
      localStream.getAudioTracks().forEach(t=>t.enabled=false);
    } else {
      localStream.getAudioTracks().forEach(t=>t.enabled=prejoinMicEnabled);
    }
    localStream.getVideoTracks().forEach(t=>t.enabled=prejoinCamEnabled);

    bindTeacherTileVideoLocalIfTeacher();

    // update presence mic/cam
    presenceRef?.update({
      micEnabled: localStream.getAudioTracks?.()[0]?.enabled ?? false,
      camEnabled: localStream.getVideoTracks?.()[0]?.enabled ?? false
    });

    if(isTranscribing){
      stopTranscription(true);
      startTranscription();
    }
    showToast('Mic source updated');
  }catch(e){
    console.error('teacherMicSelect change', e);
    showToast('Failed to change mic');
  }
});

$('teacherTargetLang').addEventListener('change', async ()=>{
  userLanguage = $('teacherTargetLang').value;
  await db.ref(`/users/${currentUser.uid}/language`).set(userLanguage);
  showToast('Target language updated');
});

/* =========================
   Invite
========================= */
$('btnInvite').addEventListener('click', async ()=>{
  try{
    const link = `${location.origin}${location.pathname}?room=${encodeURIComponent(currentRoom)}`;
    await navigator.clipboard.writeText(link);
    showToast('Invite link copied');
  }catch(_){
    showToast('Copy failed');
  }
});

/* =========================
   Bottom bar (mobile)
========================= */
$('bbSpeak').addEventListener('click', async ()=>{
  if(userRole==='student'){
    // students: toggle raise-hand or mic if allowed
    const me = participants.get(currentUser.uid) || {};
    if(me.allowedToSpeak){
      // toggle mic (allowed)
      const track = localStream?.getAudioTracks?.()[0];
      if(track){
        track.enabled = !track.enabled;
        setMicState(track.enabled ? 'Live' : 'Muted', track.enabled ? 'ok' : 'warn');
        presenceRef?.child('micEnabled')?.set(track.enabled);
        showToast(track.enabled ? 'Mic on' : 'Mic off');
      }
    } else {
      await toggleRaiseHand();
    }
  } else {
    // teacher: start/stop STT and mic enable
    if(isTranscribing){
      stopTranscription();
      showToast('Stopped');
    } else {
      startTranscription();
      showToast('Started');
    }
  }
  $('bbSpeak').classList.add('active'); setTimeout(()=>$('bbSpeak').classList.remove('active'), 400);
});
$('bbTranslate').addEventListener('click', ()=>{
  // just scroll feed into view
  $('feedColumn').scrollIntoView({behavior:'smooth',block:'start'});
  $('bbTranslate').classList.add('active'); setTimeout(()=>$('bbTranslate').classList.remove('active'), 400);
});
$('bbStudents').addEventListener('click', ()=>{
  $('mobileStudentsSheet').classList.toggle('open');
  $('bbStudents').classList.toggle('active');
});
$('btnCloseMobileStudents').addEventListener('click', ()=>{
  $('mobileStudentsSheet').classList.remove('open');
  $('bbStudents').classList.remove('active');
});
$('bbSettings').addEventListener('click', ()=>{
  openSettings();
  $('bbSettings').classList.add('active'); setTimeout(()=>$('bbSettings').classList.remove('active'), 400);
});

/* =========================
   Settings drawer
========================= */
function loadLocalSettings(){
  try{
    const raw = localStorage.getItem(SETTINGS_KEY);
    if(raw){
      const obj = JSON.parse(raw);
      settings = {...settings, ...obj};
    }
  }catch(_){}
}

function applySettingsToRoomConfig(){
  // allow overrides from settings, but keep defaults if empty
  if(settings.sttEndpoint) { /* used dynamically */ }
  if(settings.deepgramKey) roomConfig.deepgramKey = settings.deepgramKey;
  if(settings.cartesiaKey) roomConfig.cartesiaKey = settings.cartesiaKey;
  if(settings.cartesiaModelId) roomConfig.cartesiaModelId = settings.cartesiaModelId;
}

function openSettings(){
  $('settingsOverlay').classList.add('open');
  $('setRoomId').value = currentRoom || $('roomIdInput').value || '';
  $('setSttEndpoint').value = settings.sttEndpoint || '';
  $('setDeepgramKey').value = settings.deepgramKey || (roomConfig?.deepgramKey||'');
  $('setCartesiaKey').value = settings.cartesiaKey || (roomConfig?.cartesiaKey||'');
  $('setCartesiaModel').value = settings.cartesiaModelId || (roomConfig?.cartesiaModelId||'sonic-3');
  $('setNoiseToggle').classList.toggle('active', !!settings.noise);
  $('setEchoToggle').classList.toggle('active', !!settings.echo);
  $('setGainToggle').classList.toggle('active', !!settings.gain);
}
function closeSettings(){ $('settingsOverlay').classList.remove('open'); }

$('btnOpenSettings').addEventListener('click', openSettings);
$('btnCloseSettings').addEventListener('click', closeSettings);
$('settingsOverlay').addEventListener('click', (e)=>{ if(e.target === $('settingsOverlay')) closeSettings(); });

$('setNoiseToggle').addEventListener('click', ()=> $('setNoiseToggle').classList.toggle('active'));
$('setEchoToggle').addEventListener('click', ()=> $('setEchoToggle').classList.toggle('active'));
$('setGainToggle').addEventListener('click', ()=> $('setGainToggle').classList.toggle('active'));

$('btnSaveSettings').addEventListener('click', ()=>{
  settings.sttEndpoint = $('setSttEndpoint').value.trim();
  settings.deepgramKey = $('setDeepgramKey').value.trim();
  settings.cartesiaKey = $('setCartesiaKey').value.trim();
  settings.cartesiaModelId = $('setCartesiaModel').value.trim() || 'sonic-3';
  settings.noise = $('setNoiseToggle').classList.contains('active');
  settings.echo  = $('setEchoToggle').classList.contains('active');
  settings.gain  = $('setGainToggle').classList.contains('active');

  localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
  applySettingsToRoomConfig();

  closeSettings();
  showToast('Settings saved');

  // if teacher and STT active, restart to apply endpoint/key
  if(userRole==='teacher' && isTranscribing){
    stopTranscription(true);
    startTranscription();
  }
});

$('btnResetSettings').addEventListener('click', ()=>{
  if(!confirm('Reset settings to defaults?')) return;
  settings = {
    sttEndpoint: '',
    deepgramKey: '',
    cartesiaKey: '',
    cartesiaModelId: 'sonic-3',
    noise: true,
    echo: true,
    gain: true
  };
  localStorage.removeItem(SETTINGS_KEY);
  showToast('Settings reset');
  openSettings();
});

/* =========================
   Leave
========================= */
$('btnLeave').addEventListener('click', leaveRoom);

async function leaveRoom(){
  try{ await leaveStreamCall(); }catch(_){}
  try{ await presenceRef?.remove(); }catch(_){}
  try{ participantsRef?.off(); }catch(_){}
  try{ roomMetaTeacherRef?.off(); }catch(_){}
  try{ roomMetaSpeakerRef?.off(); }catch(_){}
  try{ db.ref(`/transcripts/${currentRoom}`).off(); }catch(_){}

  stopTranscription(true);
  try{ localStream?.getTracks()?.forEach(t=>t.stop()); }catch(_){}
  try{ prejoinStream?.getTracks()?.forEach(t=>t.stop()); }catch(_){}
  try{ if(currentAudio){ currentAudio.pause(); currentAudio=null; } }catch(_){}
  try{ if(meetingTimerInterval) clearInterval(meetingTimerInterval); }catch(_){}

  participants.clear();
  ttsQueue=[]; isPlayingTTS=false; processedIds.clear();
  handRaised=false;

  currentRoom=null; roomConfig=null; localStream=null; prejoinStream=null;
  teacherUserId=null; activeSpeakerUid=null;

  $('appContainer').classList.remove('active');
  $('mobileStudentsSheet').classList.remove('open');
  history.replaceState({},'',location.pathname);

  showPrejoinScreen();
}

/* =========================
   Misc
========================= */
function escapeHtml(t){ const d=document.createElement('div'); d.textContent=t||''; return d.innerHTML; }

/* Teacher console defaults */
$('teacherTargetLang').value = userLanguage || 'en';

/* Speaker select persistence */
$('speakerSelect').addEventListener('change', ()=>{ selectedSpeakerId = $('speakerSelect').value; });

/* =========================
   Service Worker + PWA
========================= */
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{
    navigator.serviceWorker.register('/run/service-worker.js')
      .then(reg=>console.log('ServiceWorker registered:',reg.scope))
      .catch(err=>console.log('ServiceWorker registration failed:',err));
  });
}
</script>
</body>
</html>