<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />

  <!-- Strict No-Zoom + Native-like -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#008069" />
  <meta name="description" content="Succes Class | Group SUCCESS ‚Äî realtime STT + per-sentence translation + Cartesia TTS" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Succes Class" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="application-name" content="Succes Class" />
  <meta http-equiv="Permissions-Policy" content="microphone=(self), camera=(self), autoplay=(self), fullscreen=(self), speaker-selection=(self), notifications=(self)" />

  <!-- Manifest placeholder (will be set to an inline data: URL at runtime) -->
  <link rel="manifest" id="manifest-link" href="manifest.json" />
  <link rel="icon" href="icons/icon-192.png" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />

  <title>Succes Class | Group SUCCESS</title>

  <script src="https://cdn.tailwindcss.com "></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css ">

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400 ;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; height: 100vh; margin: 0; overflow: hidden; touch-action: manipulation; }
    input, select, button { font-size: 16px !important; touch-action: manipulation; }
    .chat-bg { background-color: #efeae2; background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png "); background-size: 400px; }
    @media (max-width: 767px) {
      #sidebar { position: absolute; width: 100%; height: 100%; z-index: 20; transition: transform 0.3s ease; }
      #chat-main { position: absolute; width: 100%; height: 100%; z-index: 30; transform: translateX(100%); transition: transform 0.3s ease; }
      .mobile-chat-open #chat-main { transform: translateX(0); }
      .mobile-chat-open #sidebar { transform: translateX(-100%); }
    }
    .bubble-shadow { box-shadow: 0 1px 0.5px rgba(0,0,0,0.15); }
    .emotion-emoji { font-size: 1.25rem; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1)); }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(10px);} to { opacity: 1; transform: translateY(0);} }
    .message-animate { animation: slideIn 0.22s ease forwards; }
  </style>

  <!-- ===========================
       INLINE MANIFEST (single-file)
       Will be converted to data: URL at runtime.
  ============================ -->
  <script id="__manifest" type="application/json">
  {
    "name": "Succes Class ‚Ä¢ Group SUCCESS",
    "short_name": "SuccesClass",
    "description": "Group chat with per-sentence STT translation + Cartesia TTS. PWA-ready.",
    "id": "succes-class-success",
    "start_url": "./",
    "scope": "./",
    "display": "standalone",
    "display_override": ["standalone", "minimal-ui", "browser"],
    "background_color": "#f0f2f5",
    "theme_color": "#008069",
    "orientation": "portrait-primary",
    "lang": "en",
    "categories": ["education", "communication", "productivity"],
    "prefer_related_applications": false,
    "icons": [
      {
        "src": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAwMCAO7Wc1cAAAAASUVORK5CYII=",
        "sizes": "192x192",
        "type": "image/png",
        "purpose": "any maskable"
      },
      {
        "src": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAwMCAO7Wc1cAAAAASUVORK5CYII=",
        "sizes": "512x512",
        "type": "image/png",
        "purpose": "any maskable"
      }
    ],
    "permissions": ["microphone"]
  }
  </script>

  <!-- ===========================
       INLINE SERVICE WORKER (single-file)
       We will TRY blob registration first, then fall back to ./service-worker.js
  ============================ -->
  <script id="__sw" type="text/plain">
  const CACHE_NAME = "succes-class-singlefile-v1";
  const CORE = ["./"];

  self.addEventListener("install", (e) => {
    e.waitUntil(
      caches.open(CACHE_NAME).then(c => c.addAll(CORE)).then(() => self.skipWaiting())
    );
  });

  self.addEventListener("activate", (e) => {
    e.waitUntil(
      caches.keys().then(keys => Promise.all(keys.map(k => (k !== CACHE_NAME ? caches.delete(k) : Promise.resolve()))))
        .then(() => self.clients.claim())
    );
  });

  self.addEventListener("fetch", (e) => {
    const req = e.request;
    const url = new URL(req.url);

    // same-origin only
    if (url.origin !== self.location.origin) return;

    // HTML nav: network-first
    if (req.mode === "navigate" || (req.headers.get("accept") || "").includes("text/html")) {
      e.respondWith(
        fetch(req).then(res => {
          const copy = res.clone();
          caches.open(CACHE_NAME).then(c => c.put(req, copy));
          return res;
        }).catch(() => caches.match(req).then(c => c || caches.match("./")))
      );
      return;
    }

    // static: cache-first
    e.respondWith(
      caches.match(req).then(c => c || fetch(req).then(res => {
        const copy = res.clone();
        caches.open(CACHE_NAME).then(cache => cache.put(req, copy));
        return res;
      }))
    );
  });
  </script>

  <script>
    // Set manifest to inline data: URL (single-file)
    (function setInlineManifest() {
      try {
        const el = document.getElementById("__manifest");
        const json = el ? el.textContent.trim() : "";
        if (!json) return;
        const href = "data:application/manifest+json," + encodeURIComponent(json);
        const link = document.getElementById("manifest-link");
        if (link) link.href = href;
      } catch {}
    })();

    // Service worker (single-file best effort)
    (async function registerInlineSW() {
      if (!("serviceWorker" in navigator)) return;
      try {
        const code = document.getElementById("__sw")?.textContent || "";
        if (!code.trim()) throw new Error("No SW code");
        const blob = new Blob([code], { type: "text/javascript" });
        const swUrl = URL.createObjectURL(blob);
        await navigator.serviceWorker.register(swUrl, { scope: "./" });
      } catch (e) {
        // fallback file path if you do export one later
        try { await navigator.serviceWorker.register("./service-worker.js", { scope: "./" }); } catch {}
      }
      try { if (navigator.storage?.persist) await navigator.storage.persist(); } catch {}
    })();
  </script>
</head>

<body class="flex items-center justify-center">

  <!-- DELETE CONFIRMATION MODAL -->
  <div id="delete-modal" class="fixed inset-0 z-[110] bg-black/60 flex items-center justify-center p-6 hidden">
    <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl animate-in fade-in zoom-in duration-200">
      <h3 class="text-lg font-bold text-gray-800">Clear Succes Class?</h3>
      <p class="text-sm text-gray-500 mt-2">Delete all messages in this room? This cannot be undone.</p>
      <div class="flex justify-end gap-3 mt-6">
        <button onclick="toggleDeleteModal(false)" class="px-4 py-2 text-sm font-semibold text-gray-400">Cancel</button>
        <button id="confirm-delete-btn" class="px-4 py-2 text-sm font-semibold bg-red-500 text-white rounded-lg">Delete All</button>
      </div>
    </div>
  </div>

  <!-- VOICE BROWSER MODAL -->
  <div id="voice-browser-modal" class="fixed inset-0 z-[120] bg-black/80 flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-2xl w-full max-w-4xl max-h-[80vh] overflow-hidden flex flex-col">
      <div class="bg-[#008069] p-4 text-white flex justify-between items-center">
        <h3 class="text-lg font-bold">Available Voices</h3>
        <button onclick="toggleVoiceBrowser(false)" class="text-white hover:text-gray-200"><i class="fa-solid fa-times"></i></button>
      </div>
      <div class="p-4 overflow-y-auto">
        <div class="mb-4">
          <input type="text" id="voice-search" placeholder="Search voices..." class="w-full p-2 border rounded-lg">
        </div>
        <div id="voice-grid" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
      </div>
    </div>
  </div>

  <!-- GATEWAY MODAL -->
  <div id="gateway-modal" class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-md flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-300">
      <div class="bg-[#008069] p-6 text-white text-center">
        <h2 class="text-xl font-bold italic tracking-tight">Succes Class</h2>
        <p class="text-xs opacity-80 mt-1 uppercase tracking-widest">Connect to SUCCESS</p>
      </div>

      <div class="p-6 space-y-4">
        <div>
          <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Display Name</label>
          <input id="user-display-name" type="text" placeholder="Enter name" maxlength="20" class="w-full border-2 border-gray-100 rounded-xl px-4 py-2 focus:border-[#008069] outline-none">
        </div>

        <div>
          <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Room Code</label>
          <input id="room-code" type="text" value="" placeholder="SUCCESS" class="w-full border-2 border-gray-100 rounded-xl px-4 py-2 text-center text-xl font-bold focus:border-[#008069] outline-none uppercase tracking-widest">
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Gender</label>
            <select id="user-gender" class="w-full border-2 border-gray-100 rounded-lg px-3 py-2 outline-none focus:border-[#008069] bg-white text-sm">
              <option value="Male">Male</option>
              <option value="Female">Female</option>
            </select>
          </div>
          <div>
            <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Language</label>
            <select id="user-lang" class="w-full border-2 border-gray-100 rounded-lg px-3 py-2 outline-none focus:border-[#008069] bg-white text-sm"></select>
          </div>
        </div>

        <div>
          <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Voice (Based on Language & Gender)</label>
          <select id="user-voice" class="w-full border-2 border-gray-100 rounded-lg px-3 py-2 outline-none focus:border-[#008069] bg-white text-sm">
            <option value="">Auto-select (paired voice)</option>
            <option value="browse">üîç Browse All Voices‚Ä¶</option>
          </select>
          <p class="text-xs text-gray-500 mt-1">Auto uses paired voices per language. NL is forced to Flemish voice id.</p>
        </div>

        <button id="btn-connect" class="w-full bg-[#00a884] text-white font-bold py-4 rounded-xl shadow-lg hover:bg-[#008069] transition-all uppercase tracking-widest mt-2">
          Enter Group
        </button>
      </div>
    </div>
  </div>

  <!-- MAIN INTERFACE -->
  <div id="app-container" class="flex h-full w-full max-w-[1600px] bg-white overflow-hidden relative opacity-0 transition-opacity duration-500">

    <aside id="sidebar" class="w-[350px] border-r border-gray-200 bg-white flex flex-col shrink-0">
      <div class="h-[64px] bg-[#008069] flex items-center justify-between px-4 text-white shrink-0">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-full bg-teal-900 flex items-center justify-center font-bold shadow-inner">SC</div>
          <span class="font-semibold italic">Succes Class</span>
        </div>
        <div class="flex gap-4 items-center opacity-70">
          <button id="logout-btn" title="Logout" class="hover:text-red-400 transition-colors"><i class="fa-solid fa-right-from-bracket"></i></button>
          <i class="fa-solid fa-message"></i><i class="fa-solid fa-ellipsis-vertical"></i>
        </div>
      </div>

      <div id="chat-list" class="flex-1 overflow-y-auto">
        <div class="flex items-center gap-3 p-3 bg-gray-100 border-b">
          <div id="sidebar-avatar" class="w-12 h-12 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold text-lg shrink-0">SU</div>
          <div class="flex-1 overflow-hidden">
            <h3 id="sidebar-room-name" class="font-semibold text-gray-800 text-sm">SUCCESS</h3>
            <p class="text-[12px] text-teal-600 font-medium animate-pulse italic truncate">Per-sentence translate + parallel pipeline</p>
          </div>
        </div>

        <div class="p-3 border-b">
          <h4 class="text-xs font-bold text-gray-400 uppercase mb-2">Online Users</h4>
          <div id="online-users" class="space-y-2"></div>
        </div>

        <div class="p-3 border-b">
          <h4 class="text-xs font-bold text-gray-400 uppercase mb-2">Voice Status</h4>
          <div class="flex items-center justify-between">
            <span class="text-sm">TTS Playback</span>
            <div id="tts-sidebar-status" class="w-3 h-3 rounded-full bg-red-500"></div>
          </div>
          <p class="text-xs text-gray-500 mt-1">Your voice: <span id="selected-voice-name">Auto</span></p>
        </div>
      </div>

      <div class="p-3 border-t bg-gray-50">
        <div class="text-center">
          <p class="text-xs text-gray-500">Connected as: <span id="sidebar-user-name" class="font-semibold">Guest</span></p>
          <p class="text-[10px] text-gray-400" id="connection-status">Disconnected</p>
        </div>
      </div>
    </aside>

    <main id="chat-main" class="flex-1 flex flex-col bg-[#efeae2] relative shadow-2xl">
      <header class="bg-[#f0f2f5] h-[64px] flex items-center justify-between px-4 border-b border-gray-200 shrink-0 z-20">
        <div class="flex items-center gap-3">
          <button onclick="document.body.classList.remove('mobile-chat-open')" class="md:hidden text-gray-500 p-2 -ml-2"><i class="fa-solid fa-arrow-left"></i></button>
          <div id="header-avatar" class="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold shadow-sm">SU</div>
          <div>
            <h2 id="room-header-name" class="font-semibold text-gray-800 text-[15px] leading-tight">SUCCESS</h2>
            <span id="user-display-meta" class="text-[9px] text-gray-400 font-bold uppercase tracking-tight">Connecting...</span>
          </div>
        </div>
        <div class="flex gap-5 items-center">
          <button onclick="toggleDeleteModal(true)" title="Delete Chat" class="text-gray-400 hover:text-red-500 transition-colors p-2 text-lg"><i class="fa-solid fa-trash-can"></i></button>
          <button id="tts-toggle-btn" title="Toggle Playback" class="text-gray-400 hover:text-[#008069] transition-colors p-2 text-xl">
            <i id="tts-icon" class="fa-solid fa-volume-xmark"></i>
          </button>
          <i class="fa-solid fa-ellipsis-vertical text-gray-500"></i>
        </div>
      </header>

      <div id="msg-stream" class="flex-1 overflow-y-auto p-4 md:p-8 chat-bg flex flex-col gap-3"></div>

      <div class="bg-[#f0f2f5] p-2 md:p-3 flex items-center gap-2 border-t border-gray-200 relative z-40">
        <div class="flex w-full items-center gap-3 bg-white rounded-full px-4 py-2 shadow-sm">
          <button id="emotion-btn" class="text-gray-400 hover:text-yellow-500 p-1" title="Emotion">
            <i class="fa-regular fa-face-smile text-xl"></i>
          </button>
          <input id="text-input" type="text" placeholder="Type a message" class="flex-1 outline-none text-[15px] bg-transparent">
          <button id="send-btn" class="hidden text-teal-600 p-1"><i class="fa-solid fa-paper-plane text-xl"></i></button>
          <button id="mic-btn" class="text-gray-500 p-1"><i class="fa-solid fa-microphone text-xl"></i></button>
        </div>

        <div id="voice-overlay" class="absolute inset-0 bg-[#f0f2f5] z-50 flex items-center px-4 hidden">
          <div class="w-2 h-2 rounded-full bg-red-500 animate-pulse mr-3"></div>
          <span id="timer" class="font-mono text-xs text-gray-500 w-10">00:00</span>
          <div class="flex-1 h-8 flex items-center overflow-hidden mx-2"><canvas id="viz" height="30" class="w-full"></canvas></div>
          <button id="cancel-voice" class="p-2 text-gray-400 hover:text-red-500" title="Cancel"><i class="fa-solid fa-trash"></i></button>
          <button id="stop-voice" class="w-10 h-10 bg-[#00a884] text-white rounded-full flex items-center justify-center shadow-lg transform active:scale-90" title="Send"><i class="fa-solid fa-check"></i></button>
        </div>
      </div>

      <!-- Emotion Picker -->
      <div id="emotion-picker" class="absolute bottom-16 left-4 bg-white rounded-xl shadow-2xl p-3 hidden z-50">
        <div class="grid grid-cols-2 gap-2">
          <button class="emotion-option p-2 hover:bg-gray-100 rounded-lg text-left" data-emotion="neutral">üòê Neutral</button>
          <button class="emotion-option p-2 hover:bg-gray-100 rounded-lg text-left" data-emotion="happy">üòÄ Happy</button>
          <button class="emotion-option p-2 hover:bg-gray-100 rounded-lg text-left" data-emotion="sad">üò¢ Sad</button>
          <button class="emotion-option p-2 hover:bg-gray-100 rounded-lg text-left" data-emotion="angry">üò† Angry</button>
          <button class="emotion-option p-2 hover:bg-gray-100 rounded-lg text-left" data-emotion="excited">ü§© Excited</button>
          <button class="emotion-option p-2 hover:bg-gray-100 rounded-lg text-left" data-emotion="content">üòä Content</button>
          <button class="emotion-option p-2 hover:bg-gray-100 rounded-lg text-left" data-emotion="scared">üò® Scared</button>
          <button class="emotion-option p-2 hover:bg-gray-100 rounded-lg text-left" data-emotion="apologetic">üôá Apologetic</button>
          <button class="emotion-option p-2 hover:bg-gray-100 rounded-lg text-left" data-emotion="curious">ü§î Curious</button>
          <button class="emotion-option p-2 hover:bg-gray-100 rounded-lg text-left" data-emotion="amazed">üò≤ Amazed</button>
        </div>
      </div>
    </main>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js ";
    import {
      getDatabase, ref, push, set, onChildAdded, onValue, remove, update, onDisconnect
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js ";
    import { createClient, LiveTranscriptionEvents } from "https://cdn.jsdelivr.net/npm/@deepgram/sdk@3/+esm ";

    // =========================================================
    // CONFIG
    // =========================================================
    const CARTESIA_KEY = "sk_car_yWEX9Mp2LwKju8FXyosGhj";
    const CARTESIA_VERSION = "2025-04-16";
    const DEEPGRAM_KEY = "11ee938d032ce7c36c6fa82338274be5e4ada847";
    const FLEMISH_NL_VOICE_ID = "005af375-5aad-4c02-9551-7fc411430542";

    const firebaseConfig = {
      apiKey: "AIzaSyC93B2GgE3HzaWl5gW_mRroobQybaZNFJs",
      authDomain: "macx-5feca.firebaseapp.com",
      databaseURL: "https://macx-5feca-default-rtdb.asia-southeast1.firebasedatabase.app ",
      projectId: "macx-5feca"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // =========================================================
    // UI
    // =========================================================
    const ui = {
      modal: document.getElementById("gateway-modal"),
      delModal: document.getElementById("delete-modal"),
      app: document.getElementById("app-container"),
      langSelect: document.getElementById("user-lang"),
      voiceSelect: document.getElementById("user-voice"),
      msgWin: document.getElementById("msg-stream"),
      txtIn: document.getElementById("text-input"),
      sendBtn: document.getElementById("send-btn"),
      micBtn: document.getElementById("mic-btn"),
      voiceOver: document.getElementById("voice-overlay"),
      timer: document.getElementById("timer"),
      viz: document.getElementById("viz"),
      ttsBtn: document.getElementById("tts-toggle-btn"),
      ttsIcon: document.getElementById("tts-icon"),
      logout: document.getElementById("logout-btn"),
      emotionPicker: document.getElementById("emotion-picker"),
      onlineUsers: document.getElementById("online-users"),
      ttsSidebarStatus: document.getElementById("tts-sidebar-status")
    };

    // =========================================================
    // STATE
    // =========================================================
    const SESSION_KEY = "succes_session";

    let myUserId = `user-${Date.now()}-${Math.floor(Math.random() * 99999)}`;
    let userData = { name: "", room: "SUCCESS", gender: "Male", language: "nl", voiceId: null, voiceName: "Auto" };

    let joinTimestamp = null;
    let ttsEnabled = false;
    let audioQueue = [];
    let isAudioPlaying = false;
    let currentAudio = null; // Track current playing audio for cleanup

    // STT
    let isRec = false;
    let mediaRec = null;
    let dgSocket = null;
    let aCtx = null;
    let tStart = 0;
    let tInt = null;

    // Draft
    let sttDraftRef = null;
    let sttFullText = "";

    // Presence
    let userPresenceRef = null;

    // Emotion
    const EMOTIONS = { neutral:"üòê", angry:"üò†", excited:"ü§©", content:"üòä", sad:"üò¢", scared:"üò®", happy:"üòÄ", apologetic:"üôá", curious:"ü§î", amazed:"üò≤" };
    let selectedEmotion = "neutral";

    // =========================================================
    // Languages
    // =========================================================
    const fullLangList = ["Abkhaz","Acehnese","Acholi","Afar","Afrikaans","Albanian","Alur","Amharic","Arabic","Armenian","Assamese","Avar","Awadhi","Aymara","Azerbaijani","Balinese","Baluchi","Bambara","Baoul√©","Bashkir","Basque","Batak Karo","Batak Simalungun","Batak Toba","Belarusian","Bemba","Bengali","Betawi","Bhojpuri","Bikol","Bosnian","Breton","Bulgarian","Buryat","Cantonese","Catalan","Cebuano","Chamorro","Chechen","Chichewa","Chinese (Simplified)","Chinese (Traditional)","Chuukese","Chuvash","Corsican","Crimean Tatar (Cyrillic)","Crimean Tatar (Latin)","Croatian","Czech","Danish","Dari","Dhivehi","Dinka","Dogri","Dombe","Dutch","Dyula","Dzongkha","English","Esperanto","Estonian","Ewe","Faroese","Fijian","Filipino","Finnish","Fon","French","French (Canada)","Frisian","Friulian","Fulani","Ga","Galician","Georgian","German","Greek","Guarani","Gujarati","Haitian Creole","Hakha Chin","Hausa","Hawaiian","Hebrew","Hiligaynon","Hindi","Hmong","Hungarian","Hunsrik","Iban","Icelandic","Igbo","Ilocano","Indonesian","Inuktut (Latin)","Inuktut (Syllabics)","Irish","Italian","Jamaican Patois","Japanese","Javanese","Jingpo","Kalaallisut","Kannada","Kanuri","Kapampangan","Kazakh","Khasi","Khmer","Kiga","Kikongo","Kinyarwanda","Kituba","Kokborok","Komi","Konkani","Korean","Krio","Kurdish (Kurmanji)","Kurdish (Sorani)","Kyrgyz","Lao","Latgalian","Latin","Latvian","Ligurian","Limburgish","Lingala","Lithuanian","Lombard","Luganda","Luo","Luxembourgish","Macedonian","Madurese","Maithili","Makassar","Malagasy","Malay","Malay (Jawi)","Malayalam","Maltese","Mam","Manx","Maori","Marathi","Marshallese","Marwadi","Mauritian Creole","Meadow Mari","Meiteilon (Manipuri)","Minang","Mizo","Mongolian","Myanmar (Burmese)","Nahuatl (Eastern Huasteca)","Ndau","Ndebele (South)","Nepalbhasa (Newari)","Nepali","NKo","Norwegian","Nuer","Occitan","Odia (Oriya)","Oromo","Ossetian","Pangasinan","Papiamento","Pashto","Persian","Polish","Portuguese (Brazil)","Portuguese (Portugal)","Punjabi (Gurmukhi)","Punjabi (Shahmukhi)","Quechua","Q ºeqchi º","Romani","Romanian","Rundi","Russian","Sami (North)","Samoan","Sango","Sanskrit","Santali (Latin)","Santali (Ol Chiki)","Scots Gaelic","Sepedi","Serbian","Sesotho","Seychellois Creole","Shan","Shona","Sicilian","Silesian","Sindhi","Sinhala","Slovak","Slovenian","Somali","Spanish","Sundanese","Susu","Swahili","Swati","Swedish","Tahitian","Tajik","Tamazight","Tamazight (Tifinagh)","Tamil","Tatar","Telugu","Tetum","Thai","Tibetan","Tigrinya","Tiv","Tok Pisin","Tongan","Tshiluba","Tsonga","Tswana","Tulu","Tumbuka","Turkish","Turkmen","Tuvan","Twi","Udmurt","Ukrainian","Urdu","Uyghur","Uzbek","Venda","Venetian","Vietnamese","Waray","Welsh","Wolof","Xhosa","Yakut","Yiddish","Yoruba","Yucatec Maya","Zapotec","Zulu"];

    const langMap = {
      Dutch: "nl", English: "en", Filipino: "tl", Tagalog: "tl", Spanish: "es", French: "fr",
      German: "de", Arabic: "ar", Korean: "ko", Japanese: "ja", Portuguese: "pt", Hindi: "hi",
      Tamil: "ta", Telugu: "te", Russian: "ru", Italian: "it", Chinese: "zh"
    };

    // =========================================================
    // Utils
    // =========================================================
    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function cleanTranscript(t) {
      return String(t)
        .replace(/\b(uhm|um|ah|huh|er|eh|hm|uh)\b/gi, "")
        .replace(/\s\s+/g, " ")
        .trim();
    }

    function saveSession() {
      localStorage.setItem(SESSION_KEY, JSON.stringify({ ...userData, joinTime: joinTimestamp }));
    }

    // =========================================================
    // Translation
    // =========================================================
    const TRANSLATE_CONCURRENCY = 4;
    function createLimiter(max) {
      let active = 0;
      const q = [];
      const runNext = () => {
        if (active >= max || q.length === 0) return;
        active++;
        const { fn, resolve, reject } = q.shift();
        fn().then(resolve).catch(reject).finally(() => {
          active--;
          runNext();
        });
      };
      return (fn) => new Promise((resolve, reject) => {
        q.push({ fn, resolve, reject });
        runNext();
      });
    }

    const limitTranslate = createLimiter(TRANSLATE_CONCURRENCY);
    const translateCache = new Map();

    async function translate(text, from, to) {
      if (!text) return "";
      if (from === to) return text;
      const key = `${from}|${to}|${text}`;
      if (translateCache.has(key)) return translateCache.get(key);
      
      const out = await limitTranslate(async () => {
        const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl= ${from}&tl=${to}&dt=t&q=${encodeURIComponent(text)}`);
        const d = await res.json();
        return d?.[0]?.[0]?.[0] ?? text;
      });
      
      translateCache.set(key, out);
      return out;
    }

    // =========================================================
    // Cartesia Voices
    // =========================================================
    let CARTESIA_VOICES = [];
    let VOICE_MAP = {};
    const VOICES_CACHE_KEY = "cartesia_voices_cache_v2";
    const VOICES_CACHE_TTL_MS = 1000 * 60 * 60 * 24 * 3;

    function normalizeGender(g) {
      const s = String(g || "").toLowerCase();
      if (s === "masculine" || s === "feminine" || s === "gender_neutral") return s;
      if (s.includes("masc")) return "masculine";
      if (s.includes("fem")) return "feminine";
      return "gender_neutral";
    }

    async function fetchCartesiaVoicesAllPages() {
      const all = [];
      let startingAfter = null;
      while (true) {
        const url = new URL("https://api.cartesia.ai/voices ");
        url.searchParams.set("limit", "100");
        if (startingAfter) url.searchParams.set("starting_after", startingAfter);
        
        const res = await fetch(url.toString(), {
          method: "GET",
          headers: {
            "Authorization": `Bearer ${CARTESIA_KEY}`,
            "Cartesia-Version": CARTESIA_VERSION
          }
        });
        
        if (!res.ok) throw new Error(`Cartesia voices list failed: ${res.status}`);
        const json = await res.json();
        const page = Array.isArray(json?.data) ? json.data : [];
        all.push(...page);
        
        if (!json?.has_more || page.length === 0) break;
        startingAfter = page[page.length - 1]?.id || null;
        if (!startingAfter) break;
      }
      return all;
    }

    function buildVoiceMap(voices) {
      const map = {};
      for (const v of voices) {
        const lang = (v.language || "en").toLowerCase();
        const g = normalizeGender(v.gender);
        if (!map[lang]) map[lang] = { Male: null, Female: null, Neutral: null };
        if (g === "masculine" && !map[lang].Male) map[lang].Male = v.id;
        if (g === "feminine" && !map[lang].Female) map[lang].Female = v.id;
        if (g === "gender_neutral" && !map[lang].Neutral) map[lang].Neutral = v.id;
      }
      for (const k of Object.keys(map)) {
        const row = map[k];
        if (!row.Male && row.Neutral) row.Male = row.Neutral;
        if (!row.Female && row.Neutral) row.Female = row.Neutral;
      }
      // Force NL Flemish
      if (!map.nl) map.nl = { Male: null, Female: null, Neutral: null };
      map.nl.Male = FLEMISH_NL_VOICE_ID;
      map.nl.Female = FLEMISH_NL_VOICE_ID;
      map.nl.Neutral = FLEMISH_NL_VOICE_ID;
      return map;
    }

    async function loadCartesiaVoices() {
      try {
        const cached = localStorage.getItem(VOICES_CACHE_KEY);
        if (cached) {
          const obj = JSON.parse(cached);
          if (obj?.ts && Array.isArray(obj?.voices) && (Date.now() - obj.ts) < VOICES_CACHE_TTL_MS) {
            CARTESIA_VOICES = obj.voices;
            VOICE_MAP = buildVoiceMap(CARTESIA_VOICES);
            return;
          }
        }
      } catch {}

      try {
        const voices = await fetchCartesiaVoicesAllPages();
        CARTESIA_VOICES = voices;
        VOICE_MAP = buildVoiceMap(voices);
        try { localStorage.setItem(VOICES_CACHE_KEY, JSON.stringify({ ts: Date.now(), voices })); } catch {}
      } catch (e) {
        CARTESIA_VOICES = [];
        VOICE_MAP = {
          nl: { Male: FLEMISH_NL_VOICE_ID, Female: FLEMISH_NL_VOICE_ID, Neutral: FLEMISH_NL_VOICE_ID },
          en: { Male: "5ee9feff-1265-424a-9d7f-8e4d431a12c7", Female: "e07c00bc-4134-4eae-9ea4-1a55fb45746b", Neutral: null }
        };
        console.warn("Cartesia voice fetch failed, using fallback.", e);
      }
    }

    function updateVoiceSelectOptions(lang, uiGender) {
      const keep = Array.from(ui.voiceSelect.options).filter(o => (o.value === "" || o.value === "browse"));
      ui.voiceSelect.innerHTML = "";
      keep.forEach(o => ui.voiceSelect.appendChild(o));

      const L = (lang || "en").toLowerCase();
      if (L === "nl") {
        const forced = document.createElement("option");
        forced.value = FLEMISH_NL_VOICE_ID;
        forced.textContent = "Dutch Flemish (forced)";
        forced.selected = true;
        ui.voiceSelect.insertBefore(forced, ui.voiceSelect.options[1] || null);
      }

      const list = CARTESIA_VOICES.filter(v => (v.language || "en").toLowerCase() === L);
      const want = uiGender === "Female" ? "feminine" : "masculine";
      const filtered = list.filter(v => {
        const g = normalizeGender(v.gender);
        return g === want || g === "gender_neutral";
      });

      for (const v of filtered.slice(0, 250)) {
        const opt = document.createElement("option");
        opt.value = v.id;
        opt.textContent = v.name || v.id;
        ui.voiceSelect.appendChild(opt);
      }
    }

    window.toggleVoiceBrowser = (show) => {
      const modal = document.getElementById("voice-browser-modal");
      if (!modal) return;
      if (show) populateVoiceBrowser();
      modal.classList.toggle("hidden", !show);
    };

    function populateVoiceBrowser() {
      const grid = document.getElementById("voice-grid");
      const search = document.getElementById("voice-search");
      grid.innerHTML = "";
      const voices = CARTESIA_VOICES.length ? CARTESIA_VOICES : [{ id: FLEMISH_NL_VOICE_ID, name: "Dutch Flemish (forced)", description: "Forced Flemish voice for Dutch", language: "nl", gender: "masculine" }];

      for (const v of voices) {
        const card = document.createElement("div");
        card.className = "border rounded-lg p-3 hover:bg-gray-50 cursor-pointer";
        const lang = (v.language || "en").toUpperCase();
        const g = normalizeGender(v.gender);
        card.innerHTML = `
          <div class="flex justify-between items-start">
            <div class="pr-4">
              <h4 class="font-semibold">${escapeHtml(v.name || v.id)}</h4>
              <p class="text-sm text-gray-600">${escapeHtml(v.description || "No description")}</p>
              <div class="flex gap-2 mt-2 flex-wrap">
                <span class="text-xs px-2 py-1 bg-gray-100 rounded">${escapeHtml(g)}</span>
                <span class="text-xs px-2 py-1 bg-gray-100 rounded">${escapeHtml(lang)}</span>
              </div>
            </div>
            <button class="select-voice-btn text-[#008069] hover:text-[#00a884]"><i class="fa-solid fa-check"></i></button>
          </div>`;
        
        card.querySelector(".select-voice-btn").onclick = () => {
          userData.voiceId = (userData.language === "nl") ? FLEMISH_NL_VOICE_ID : v.id;
          userData.voiceName = (userData.language === "nl") ? "Dutch Flemish (forced)" : (v.name || "Custom");
          document.getElementById("selected-voice-name").textContent = userData.voiceName;
          ui.voiceSelect.value = userData.voiceId;
          saveSession();
          window.toggleVoiceBrowser(false);
        };
        grid.appendChild(card);
      }

      search.value = "";
      search.oninput = (e) => {
        const term = e.target.value.toLowerCase();
        Array.from(grid.children).forEach(card => {
          card.style.display = card.textContent.toLowerCase().includes(term) ? "block" : "none";
        });
      };
    }

    // =========================================================
    // FIXED: TTS Helpers
    // =========================================================
    function escapeForSSML(s) {
      return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
    }

    function emotionToSpeed(em) {
      const map = { excited:1.12, happy:1.06, curious:1.03, neutral:1.0, content:0.98, apologetic:0.95, sad:0.92, scared:0.96, angry:1.02, amazed:1.05 };
      return Math.max(0.5, Math.min(2.0, map[em] ?? 1.0));
    }

    function emotionToVolume(em) {
      const map = { excited:1.08, happy:1.03, neutral:1.0, content:0.98, apologetic:0.95, sad:0.92, scared:0.96, angry:1.05, amazed:1.02, curious:1.0 };
      return Math.max(0.5, Math.min(2.0, map[em] ?? 1.0));
    }

    // FIXED: Proper SSML with standard prosody tags
    function buildSSML(text, emotion) {
      const safe = escapeForSSML(text);
      // Add breaks for punctuation
      let processed = safe
        .replace(/\.\.\./g, '<break time="400ms"/>')
        .replace(/([,;])\s+/g, '$1<break time="150ms"/>')
        .replace(/([.?!])\s+/g, '$1<break time="250ms"/>')
        .replace(/\n+/g, '<break time="400ms"/>');
      
      // Only wrap in prosody/speak if we have valid content
      if (!processed.trim()) return processed;
      
      const rate = Math.round((emotionToSpeed(emotion) - 1) * 100);
      const volume = Math.round((emotionToVolume(emotion) - 1) * 100);
      
      // Use standard SSML prosody tags
      return `<speak><prosody rate="${rate > 0 ? '+' : ''}${rate}%" volume="${volume > 0 ? '+' : ''}${volume}%">${processed}</prosody></speak>`;
    }

    function pickPairedVoiceId(targetLang, speakerGender, receiverForcedVoiceId=null) {
      const L = (targetLang || "en").toLowerCase();
      if (L === "nl") return FLEMISH_NL_VOICE_ID;
      if (receiverForcedVoiceId) return receiverForcedVoiceId;
      
      const row = VOICE_MAP[L];
      if (row) {
        if (speakerGender === "Female" && row.Female) return row.Female;
        if (row.Male) return row.Male;
        if (row.Neutral) return row.Neutral;
      }
      
      // Ultimate fallback to English voices
      return speakerGender === "Female" 
        ? "e07c00bc-4134-4eae-9ea4-1a55fb45746b" 
        : "5ee9feff-1265-424a-9d7f-8e4d431a12c7";
    }

    // FIXED: Audio Queue with proper cleanup and autoplay handling
    async function processAudioQueue() {
      if (isAudioPlaying || audioQueue.length === 0 || !ttsEnabled) return;
      isAudioPlaying = true;

      const item = audioQueue.shift();
      try {
        const voiceId = pickPairedVoiceId(item.lang, item.gender, item.voiceId || null);
        const ssml = buildSSML(item.text, item.emotion || "neutral");
        
        // Calculate numeric values for generation_config
        const speed = emotionToSpeed(item.emotion || "neutral");
        const volume = emotionToVolume(item.emotion || "neutral");

        const res = await fetch("https://api.cartesia.ai/tts/bytes ", {
          method: "POST",
          headers: {
            "Cartesia-Version": CARTESIA_VERSION,
            "X-API-Key": CARTESIA_KEY,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            model_id: "sonic-3-latest",
            transcript: ssml,
            voice: { mode: "id", id: voiceId },
            language: item.lang,
            output_format: { container: "wav", encoding: "pcm_f32le", sample_rate: 44100 },
            generation_config: { 
              speed: speed,
              volume: volume,
              emotion: item.emotion || "neutral"
            }
          })
        });

        if (!res.ok) {
          const errText = await res.text().catch(() => "Unknown error");
          throw new Error(`TTS failed ${res.status}: ${errText}`);
        }

        const blob = await res.blob();
        if (blob.size === 0) throw new Error("Empty audio response");

        const audioUrl = URL.createObjectURL(blob);
        currentAudio = new Audio(audioUrl);
        
        currentAudio.onended = () => {
          URL.revokeObjectURL(audioUrl);
          isAudioPlaying = false;
          currentAudio = null;
          processAudioQueue();
        };
        
        currentAudio.onerror = (e) => {
          console.error("Audio playback error:", e);
          URL.revokeObjectURL(audioUrl);
          isAudioPlaying = false;
          currentAudio = null;
          processAudioQueue();
        };

        // Handle autoplay restrictions gracefully
        try {
          await currentAudio.play();
        } catch (playErr) {
          console.warn("Autoplay prevented, waiting for user interaction", playErr);
          // Pause processing until TTS is toggled again
          isAudioPlaying = false;
          currentAudio = null;
          // Re-queue the item at the front
          audioQueue.unshift(item);
          // Disable TTS to prevent infinite loop
          ttsEnabled = false;
          updateTTSButton();
        }
        
      } catch (e) {
        console.error("TTS generation error:", e);
        isAudioPlaying = false;
        currentAudio = null;
        setTimeout(() => processAudioQueue(), 1000); // Retry after delay
      }
    }

    function updateTTSButton() {
      ui.ttsIcon.className = ttsEnabled ? "fa-solid fa-volume-high text-[#008069]" : "fa-solid fa-volume-xmark text-gray-400";
      ui.ttsSidebarStatus.className = ttsEnabled ? "w-3 h-3 rounded-full bg-green-500" : "w-3 h-3 rounded-full bg-red-500";
    }

    function clearAudioQueue() {
      audioQueue = [];
      if (currentAudio) {
        currentAudio.pause();
        currentAudio.onended = null;
        currentAudio = null;
      }
      isAudioPlaying = false;
    }

    // =========================================================
    // Presence
    // =========================================================
    function updateUserPresence() {
      if (!userPresenceRef) userPresenceRef = ref(db, `presence/${userData.room}/${myUserId}`);
      set(userPresenceRef, {
        name: userData.name,
        gender: userData.gender,
        language: userData.language,
        voice: userData.voiceName,
        lastSeen: Date.now(),
        online: true
      });
      onDisconnect(userPresenceRef).remove();
    }

    function monitorOnlineUsers() {
      const presenceRef = ref(db, `presence/${userData.room}`);
      onValue(presenceRef, (snapshot) => {
        ui.onlineUsers.innerHTML = "";
        const users = snapshot.val() || {};
        Object.entries(users).forEach(([uid, u]) => {
          if (uid === myUserId) return;
          const userDiv = document.createElement("div");
          userDiv.className = "flex items-center justify-between p-2 hover:bg-gray-50 rounded";
          userDiv.innerHTML = `
            <div class="flex items-center gap-2">
              <div class="w-8 h-8 rounded-full ${u.gender === "Female" ? "bg-pink-500" : "bg-blue-500"} flex items-center justify-center text-white text-xs">
                ${(u.name || "?").charAt(0)}
              </div>
              <div>
                <p class="font-medium text-sm">${escapeHtml(u.name || "Unknown")}</p>
                <p class="text-xs text-gray-500">${escapeHtml(u.language || "")} ‚Ä¢ ${escapeHtml(u.gender || "")}</p>
              </div>
            </div>
            <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
          `;
          ui.onlineUsers.appendChild(userDiv);
        });
      });
    }

    // =========================================================
    // Render
    // =========================================================
    function renderBubble(msg, isLive = false) {
      const isMe = msg.senderId === myUserId;
      const div = document.createElement("div");
      div.className = `flex ${isMe ? "justify-end" : "justify-start"} ${isLive ? "is-live opacity-50" : "message-animate"}`;

      const display = (!isMe && msg.translated) ? msg.translated : msg.text;
      const metaLang = (!isMe && msg.translated && msg.lang !== userData.language) ? `${msg.lang}‚Üí${userData.language}` : msg.lang;
      const voiceInfo = (msg.voiceName && msg.voiceName !== "Auto") ? ` ‚Ä¢ ${msg.voiceName}` : "";

      div.innerHTML = `
        <div class="${isMe ? "bg-[#d9fdd3] rounded-tr-none" : "bg-white rounded-tl-none"} p-3 rounded-lg bubble-shadow max-w-[85%] flex items-end gap-2">
          <div class="flex-1">
            <p class="text-[14.5px] text-[#111b21] leading-tight pr-1 pb-1">${escapeHtml(display)}</p>
            <div class="flex items-center gap-1">
              <span class="text-[8px] text-gray-400 font-bold uppercase tracking-tighter">
                ${escapeHtml(msg.senderName)} ‚Ä¢ ${escapeHtml(msg.gender)} ‚Ä¢ ${escapeHtml(metaLang)}${escapeHtml(voiceInfo)}
              </span>
            </div>
          </div>
          <div class="emotion-emoji shrink-0" title="${escapeHtml(msg.emotion || "neutral")}">${msg.emoji || "üòê"}</div>
        </div>
      `;
      ui.msgWin.appendChild(div);
      ui.msgWin.scrollTop = ui.msgWin.scrollHeight;
    }

    // =========================================================
    // Draft & Messages
    // =========================================================
    function setDraftMessage(text) {
      const cleaned = cleanTranscript(text);
      if (!cleaned) return;
      if (!sttDraftRef) sttDraftRef = push(ref(db, `chats/${userData.room}/drafts`));
      set(sttDraftRef, {
        text: cleaned,
        senderId: myUserId,
        senderName: userData.name,
        gender: userData.gender,
        lang: userData.language,
        voiceId: userData.voiceId,
        voiceName: userData.voiceName,
        emotion: selectedEmotion,
        emoji: EMOTIONS[selectedEmotion] || "üòê",
        timestamp: Date.now()
      });
    }

    function clearDraftMessage() {
      if (!sttDraftRef) return;
      remove(sttDraftRef);
      sttDraftRef = null;
    }

    function pushTextMessage(text) {
      const t = cleanTranscript(text);
      if (!t) return;
      const msgRef = push(ref(db, `chats/${userData.room}/messages`));
      set(msgRef, {
        text: t,
        senderId: myUserId,
        senderName: userData.name,
        gender: userData.gender,
        lang: userData.language,
        voiceId: userData.voiceId,
        voiceName: userData.voiceName,
        emotion: selectedEmotion,
        emoji: EMOTIONS[selectedEmotion] || "üòê",
        timestamp: Date.now(),
        is_sentence: false
      });
    }

    function pushSentenceMessage(sentenceText) {
      const t = cleanTranscript(sentenceText);
      if (!t) return;
      const msgRef = push(ref(db, `chats/${userData.room}/messages`));
      set(msgRef, {
        text: t,
        senderId: myUserId,
        senderName: userData.name,
        gender: userData.gender,
        lang: userData.language,
        voiceId: userData.voiceId,
        voiceName: userData.voiceName,
        emotion: selectedEmotion,
        emoji: EMOTIONS[selectedEmotion] || "üòê",
        timestamp: Date.now(),
        is_sentence: true
      });
    }

    // =========================================================
    // FIXED: Message Handling with TTS Queue Management
    // =========================================================
    let arrivalIndex = 0;
    let nextFlush = 0;
    const ready = new Map();
    
    function scheduleIncomingMessage(msg) {
      const idx = arrivalIndex++;
      (async () => {
        // Only translate messages from others received after joining
        if (msg.senderId !== myUserId && msg.timestamp >= joinTimestamp) {
          const from = (msg.lang || "en").toLowerCase();
          const to = (userData.language || "en").toLowerCase();
          if (from !== to) {
            msg.translated = await translate(msg.text, from, to);
          } else {
            msg.translated = msg.text;
          }
        } else {
          msg.translated = msg.text;
        }
        
        ready.set(idx, msg);
        flushReady();
      })().catch((e) => {
        console.error("Incoming pipeline error:", e);
        msg.translated = msg.text;
        ready.set(idx, msg);
        flushReady();
      });
    }

    function flushReady() {
      while (ready.has(nextFlush)) {
        const msg = ready.get(nextFlush);
        ready.delete(nextFlush);
        nextFlush++;

        renderBubble(msg, false);

        // FIXED: Only queue for TTS if TTS is enabled (prevent memory leak)
        if (msg.senderId !== myUserId && msg.timestamp >= joinTimestamp && ttsEnabled) {
          const outLang = (userData.language || "en").toLowerCase();
          const spokenText = msg.translated || msg.text;
          
          audioQueue.push({
            text: spokenText,
            gender: msg.gender || "Male",
            emotion: msg.emotion || "neutral",
            lang: outLang,
            voiceId: userData.voiceId || null
          });
          
          processAudioQueue();
        }
      }
    }

    // =========================================================
    // Firebase bindings
    // =========================================================
    function bindFirebase(room) {
      ui.msgWin.innerHTML = "";
      updateUserPresence();
      monitorOnlineUsers();

      onChildAdded(ref(db, `chats/${room}/messages`), (snap) => {
        const msg = snap.val();
        if (!msg) return;
        scheduleIncomingMessage(msg);
      });

      onValue(ref(db, `chats/${room}/drafts`), (snap) => {
        document.querySelectorAll(".is-live").forEach(el => el.remove());
        const drafts = snap.val();
        if (!drafts) return;
        Object.values(drafts).forEach(val => {
          if (val && val.senderId !== myUserId) renderBubble(val, true);
        });
      });
    }

    // =========================================================
    // Deepgram STT
    // =========================================================
    async function startVoice() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }
        });

        isRec = true;
        ui.voiceOver.classList.remove("hidden");
        setupViz(stream);

        sttFullText = "";
        clearDraftMessage();
        setDraftMessage("‚Ä¶");

        tStart = Date.now();
        tInt = setInterval(() => {
          const s = Math.floor((Date.now() - tStart) / 1000);
          ui.timer.innerText = `${String(Math.floor(s / 60)).padStart(2, "0")}:${String(s % 60).padStart(2, "0")}`;
        }, 1000);

        const dgClient = createClient(DEEPGRAM_KEY);
        dgSocket = dgClient.listen.live({
          model: "nova-3",
          language: userData.language,
          smart_format: true,
          punctuate: true,
          interim_results: true,
          vad_events: true,
          endpointing: 900,
          utterance_end_ms: 1200
        });

        dgSocket.on(LiveTranscriptionEvents.Open, () => {
          mediaRec = new MediaRecorder(stream, { mimeType: "audio/webm" });
          mediaRec.ondataavailable = (e) => {
            if (e.data.size > 0 && dgSocket.getReadyState() === 1) dgSocket.send(e.data);
          };
          mediaRec.start(250);
        });

        dgSocket.on(LiveTranscriptionEvents.Transcript, (d) => {
          const txt = (d?.channel?.alternatives?.[0]?.transcript || "").trim();
          if (!txt) return;

          if (d.is_final) {
            pushSentenceMessage(txt);
            sttFullText = (sttFullText ? (sttFullText + " " + txt) : txt).trim();
            setDraftMessage(sttFullText);
          } else {
            const merged = (sttFullText ? (sttFullText + " " + txt) : txt).trim();
            setDraftMessage(merged);
          }
        });

        dgSocket.on(LiveTranscriptionEvents.Error, (err) => {
          console.error("Deepgram error:", err);
          stopVoice(false);
        });

      } catch (e) {
        console.error("Mic/STT error:", e);
        stopVoice(false);
        alert("Microphone error/permission denied.");
      }
    }

    function stopVoice(save) {
      if (!isRec) return;
      isRec = false;
      try { mediaRec?.stop(); } catch {}
      try { dgSocket?.finish(); } catch {}
      clearInterval(tInt);

      ui.voiceOver.classList.add("hidden");
      ui.timer.innerText = "00:00";
      clearDraftMessage();
      sttFullText = "";
    }

    function setupViz(stream) {
      if (!aCtx) aCtx = new AudioContext();
      const aAn = aCtx.createAnalyser();
      aAn.fftSize = 64;
      aAn.smoothingTimeConstant = 0.82;
      const src = aCtx.createMediaStreamSource(stream);
      src.connect(aAn);

      const b = new Uint8Array(aAn.frequencyBinCount);
      const ctx = ui.viz.getContext("2d");
      ui.viz.width = ui.viz.parentElement.offsetWidth;

      const draw = () => {
        if (!isRec) { try { src.disconnect(); } catch {} return; }
        requestAnimationFrame(draw);
        aAn.getByteFrequencyData(b);
        ctx.clearRect(0, 0, ui.viz.width, ui.viz.height);

        const barWidth = (ui.viz.width / b.length) * 2;
        let x = 0;
        for (let i = 0; i < b.length; i++) {
          const barHeight = (b[i] / 255) * 30;
          const grad = ctx.createLinearGradient(0, 0, 0, 30);
          grad.addColorStop(0, "#00a884");
          grad.addColorStop(1, "#008069");
          ctx.fillStyle = grad;
          ctx.fillRect(x, (30 - barHeight) / 2, barWidth - 1, barHeight);
          x += barWidth;
        }
      };
      draw();
    }

    // =========================================================
    // Connect / App flow
    // =========================================================
    function connect(isAuto) {
      if (!isAuto) {
        const n = document.getElementById("user-display-name").value.trim();
        const r = document.getElementById("room-code").value.trim().toUpperCase();
        if (!n) return alert("Enter Name");

        userData.name = n.substring(0, 8);
        userData.room = r || "SUCCESS";
        userData.gender = document.getElementById("user-gender").value;
        userData.language = ui.langSelect.value;

        const v = ui.voiceSelect.value;
        if (v && v !== "browse") {
          userData.voiceId = (userData.language === "nl") ? FLEMISH_NL_VOICE_ID : v;
          userData.voiceName = (userData.language === "nl") ? "Dutch Flemish (forced)" : "Custom";
        } else {
          userData.voiceId = null;
          userData.voiceName = "Auto";
        }

        joinTimestamp = Date.now();
        saveSession();
      }

      ui.modal.classList.add("hidden");
      ui.app.classList.remove("opacity-0");

      document.getElementById("room-header-name").innerText = userData.room;
      document.getElementById("sidebar-room-name").innerText = userData.room;
      document.getElementById("sidebar-user-name").innerText = userData.name;
      document.getElementById("connection-status").textContent = "Connected";
      document.getElementById("selected-voice-name").textContent = userData.voiceName;

      document.getElementById("user-display-meta").innerText =
        `${userData.name} ‚Ä¢ ${userData.gender} ‚Ä¢ ${userData.language.toUpperCase()}`;

      document.body.classList.add("mobile-chat-open");
      bindFirebase(userData.room);
    }

    // =========================================================
    // Init UI + Events
    // =========================================================
    ui.langSelect.innerHTML = "";
    for (const label of fullLangList) {
      const opt = document.createElement("option");
      opt.value = langMap[label] || "en";
      opt.textContent = (label === "Dutch") ? "Dutch Flemish" : label;
      if (label === "Dutch") opt.selected = true;
      ui.langSelect.appendChild(opt);
    }

    window.toggleDeleteModal = (show) => ui.delModal.classList.toggle("hidden", !show);

    document.getElementById("confirm-delete-btn").onclick = () => {
      remove(ref(db, `chats/${userData.room}`));
      toggleDeleteModal(false);
      ui.msgWin.innerHTML = "";
    };

    ui.logout.onclick = () => {
      try { if (userPresenceRef) remove(userPresenceRef); } catch {}
      clearAudioQueue(); // Clear TTS on logout
      localStorage.removeItem(SESSION_KEY);
      location.reload();
    };

    document.getElementById("btn-connect").onclick = () => connect(false);

    // FIXED: TTS Toggle with queue management
    ui.ttsBtn.onclick = () => {
      ttsEnabled = !ttsEnabled;
      updateTTSButton();
      
      if (ttsEnabled) {
        // Resume context if suspended (browser policy)
        if (aCtx && aCtx.state === 'suspended') aCtx.resume();
        processAudioQueue();
      } else {
        clearAudioQueue();
      }
    };

    ui.txtIn.oninput = () => {
      const v = ui.txtIn.value.trim();
      ui.sendBtn.classList.toggle("hidden", v === "");
      ui.micBtn.classList.toggle("hidden", v !== "");
    };

    ui.txtIn.onkeypress = (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        if (ui.txtIn.value.trim()) {
          pushTextMessage(ui.txtIn.value.trim());
          ui.txtIn.value = "";
          ui.txtIn.oninput();
        }
      }
    };

    ui.sendBtn.onclick = () => {
      if (ui.txtIn.value.trim()) {
        pushTextMessage(ui.txtIn.value.trim());
        ui.txtIn.value = "";
        ui.txtIn.oninput();
      }
    };

    ui.micBtn.onclick = startVoice;
    document.getElementById("stop-voice").onclick = () => stopVoice(true);
    document.getElementById("cancel-voice").onclick = () => stopVoice(false);

    document.getElementById("emotion-btn").onclick = (e) => {
      e.stopPropagation();
      ui.emotionPicker.classList.toggle("hidden");
    };

    document.querySelectorAll(".emotion-option").forEach(btn => {
      btn.onclick = (e) => {
        selectedEmotion = e.currentTarget.dataset.emotion || "neutral";
        ui.emotionPicker.classList.add("hidden");
      };
    });

    document.addEventListener("click", () => ui.emotionPicker.classList.add("hidden"));

    ui.langSelect.onchange = () => updateVoiceSelectOptions(ui.langSelect.value, document.getElementById("user-gender").value);
    document.getElementById("user-gender").onchange = () => updateVoiceSelectOptions(ui.langSelect.value, document.getElementById("user-gender").value);

    ui.voiceSelect.onchange = (e) => {
      if (e.target.value === "browse") {
        window.toggleVoiceBrowser(true);
        e.target.value = "";
      }
    };

    document.getElementById("voice-browser-modal").onclick = (e) => {
      if (e.target.id === "voice-browser-modal") window.toggleVoiceBrowser(false);
    };

    document.addEventListener("visibilitychange", () => {
      if (!userData.room) return;
      const p = ref(db, `presence/${userData.room}/${myUserId}`);
      if (document.hidden) update(p, { lastSeen: Date.now(), online: false });
      else updateUserPresence();
    });

    window.addEventListener("beforeunload", () => {
      try { if (userPresenceRef) remove(userPresenceRef); } catch {}
      clearAudioQueue();
    });

    // =========================================================
    // BOOT
    // =========================================================
    await loadCartesiaVoices();
    updateVoiceSelectOptions(ui.langSelect.value, document.getElementById("user-gender").value);

    const saved = localStorage.getItem(SESSION_KEY);
    if (saved) {
      try {
        const d = JSON.parse(saved);
        userData = { ...userData, ...d };
        joinTimestamp = d.joinTime || Date.now();
        connect(true);
      } catch {}
    }
  </script>
</body>
</html>
