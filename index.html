<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ORBIT | Group SUCCESS</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; height: 100vh; margin: 0; overflow: hidden; touch-action: manipulation; }
        
        /* Native Mobile Lock: Disable Zoom */
        input, select, button { font-size: 16px !important; touch-action: manipulation; }
        
        .chat-bg { background-color: #efeae2; background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png"); background-size: 400px; }
        
        @media (max-width: 767px) {
            #sidebar { position: absolute; width: 100%; height: 100%; z-index: 20; transition: transform 0.3s ease; }
            #chat-main { position: absolute; width: 100%; height: 100%; z-index: 30; transform: translateX(100%); transition: transform 0.3s ease; }
            .mobile-chat-open #chat-main { transform: translateX(0); }
            .mobile-chat-open #sidebar { transform: translateX(-100%); }
        }

        .bubble-shadow { box-shadow: 0 1px 0.5px rgba(0,0,0,0.15); }
        .emotion-emoji { font-size: 1.25rem; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1)); }
    </style>
</head>
<body class="flex items-center justify-center">

    <!-- DELETE CONFIRMATION MODAL -->
    <div id="delete-modal" class="fixed inset-0 z-[110] bg-black/60 flex items-center justify-center p-6 hidden">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl animate-in fade-in zoom-in duration-200">
            <h3 class="text-lg font-bold text-gray-800">Clear Conversation?</h3>
            <p class="text-sm text-gray-500 mt-2">Delete all messages in this room? This cannot be undone.</p>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="toggleDeleteModal(false)" class="px-4 py-2 text-sm font-semibold text-gray-400">Cancel</button>
                <button id="confirm-delete-btn" class="px-4 py-2 text-sm font-semibold bg-red-500 text-white rounded-lg">Delete All</button>
            </div>
        </div>
    </div>

    <!-- GATEWAY MODAL -->
    <div id="gateway-modal" class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-md flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-300">
            <div class="bg-[#008069] p-6 text-white text-center">
                <h2 class="text-xl font-bold">Group Gateway</h2>
                <p class="text-xs opacity-80 uppercase tracking-widest mt-1">Join SUCCESS Room</p>
            </div>
            
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Display Name</label>
                    <input id="user-display-name" type="text" placeholder="Enter name" maxlength="20" class="w-full border-2 border-gray-100 rounded-xl px-4 py-2 focus:border-[#008069] outline-none">
                </div>

                <div>
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Room Code</label>
                    <input id="room-code" type="text" value="" placeholder="SUCCESS" class="w-full border-2 border-gray-100 rounded-xl px-4 py-2 text-center text-xl font-bold focus:border-[#008069] outline-none uppercase tracking-widest">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Gender</label>
                        <select id="user-gender" class="w-full border-2 border-gray-100 rounded-lg px-3 py-2 outline-none focus:border-[#008069] bg-white text-sm">
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Language</label>
                        <select id="user-lang" class="w-full border-2 border-gray-100 rounded-lg px-3 py-2 outline-none focus:border-[#008069] bg-white text-sm">
                            <!-- Populated by JS -->
                        </select>
                    </div>
                </div>

                <button id="btn-connect" class="w-full bg-[#00a884] text-white font-bold py-4 rounded-xl shadow-lg hover:bg-[#008069] transition-all uppercase tracking-widest mt-2">
                    Start Session
                </button>
            </div>
        </div>
    </div>

    <!-- MAIN INTERFACE -->
    <div id="app-container" class="flex h-full w-full max-w-[1600px] bg-white overflow-hidden relative opacity-0 transition-opacity duration-500">
        
        <!-- SIDEBAR -->
        <aside id="sidebar" class="w-[350px] border-r border-gray-200 bg-white flex flex-col shrink-0">
            <div class="h-[64px] bg-[#008069] flex items-center justify-between px-4 text-white shrink-0">
                <div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full bg-teal-900 flex items-center justify-center font-bold shadow-inner">GE</div></div>
                <div class="flex gap-4 items-center opacity-70">
                    <button id="logout-btn" title="Logout" class="hover:text-red-400 transition-colors"><i class="fa-solid fa-right-from-bracket"></i></button>
                    <i class="fa-solid fa-message"></i><i class="fa-solid fa-ellipsis-vertical"></i>
                </div>
            </div>
            <div id="chat-list" class="flex-1 overflow-y-auto">
                <div class="flex items-center gap-3 p-3 bg-gray-100 border-b border-gray-100">
                    <div id="sidebar-avatar" class="w-12 h-12 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold text-lg shrink-0">SU</div>
                    <div class="flex-1 overflow-hidden">
                        <h3 id="sidebar-room-name" class="font-semibold text-gray-800 text-sm">SUCCESS</h3>
                        <p class="text-[12px] text-teal-600 font-medium animate-pulse italic truncate uppercase tracking-tighter">Parallel Audio & Paired Voices Active</p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- CHAT PANEL -->
        <main id="chat-main" class="flex-1 flex flex-col bg-[#efeae2] relative shadow-2xl">
            <header class="bg-[#f0f2f5] h-[64px] flex items-center justify-between px-4 border-b border-gray-200 shrink-0 z-20">
                <div class="flex items-center gap-3">
                    <button onclick="document.body.classList.remove('mobile-chat-open')" class="md:hidden text-gray-500 p-2 -ml-2"><i class="fa-solid fa-arrow-left"></i></button>
                    <div id="header-avatar" class="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold shadow-sm text-xs">SU</div>
                    <div>
                        <h2 id="room-header-name" class="font-semibold text-gray-800 text-[15px] leading-tight">SUCCESS</h2>
                        <span id="user-display-meta" class="text-[9px] text-gray-400 font-bold uppercase tracking-tight">Connecting...</span>
                    </div>
                </div>
                <div class="flex gap-5 items-center">
                    <button onclick="toggleDeleteModal(true)" class="text-gray-400 hover:text-red-500 transition-colors p-2 text-lg"><i class="fa-solid fa-trash-can"></i></button>
                    <button id="tts-toggle-btn" class="text-gray-400 hover:text-[#008069] transition-colors p-2 text-xl"><i id="tts-icon" class="fa-solid fa-volume-xmark"></i></button>
                    <i class="fa-solid fa-ellipsis-vertical text-gray-500"></i>
                </div>
            </header>

            <div id="msg-stream" class="flex-1 overflow-y-auto p-4 md:p-8 chat-bg flex flex-col gap-3 scroll-smooth"></div>

            <div class="bg-[#f0f2f5] p-2 md:p-3 flex items-center gap-2 border-t border-gray-200 relative z-40">
                <div class="flex w-full items-center gap-3 bg-white rounded-full px-4 py-2 shadow-sm">
                    <i class="fa-regular fa-face-smile text-gray-400 text-xl cursor-pointer"></i>
                    <input id="text-input" type="text" placeholder="Type a message" class="flex-1 outline-none text-[15px] bg-transparent">
                    <button id="send-btn" class="hidden text-teal-600 p-1"><i class="fa-solid fa-paper-plane text-xl"></i></button>
                    <button id="mic-btn" class="text-gray-500 p-1"><i class="fa-solid fa-microphone text-xl"></i></button>
                </div>

                <div id="voice-overlay" class="absolute inset-0 bg-[#f0f2f5] z-50 flex items-center px-4 hidden">
                    <div class="w-2 h-2 rounded-full bg-red-500 animate-pulse mr-3"></div>
                    <span id="timer" class="font-mono text-xs text-gray-500 w-10">00:00</span>
                    <div class="flex-1 h-8 flex items-center overflow-hidden mx-2"><canvas id="viz" height="30" class="w-full"></canvas></div>
                    <button id="cancel-voice" class="p-2 text-gray-400 hover:text-red-500"><i class="fa-solid fa-trash"></i></button>
                    <button id="stop-voice" class="w-10 h-10 bg-[#00a884] text-white rounded-full flex items-center justify-center shadow-lg transform active:scale-90"><i class="fa-solid fa-check"></i></button>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, onChildAdded, onValue, remove, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { createClient, LiveTranscriptionEvents } from 'https://cdn.jsdelivr.net/npm/@deepgram/sdk@3/+esm';

        // --- KEYS & CONFIG ---
        const CARTESIA_KEY = "sk_car_yWEX9Mp2LwKju8FXyosGhj";
        const DEEPGRAM_KEY = '11ee938d032ce7c36c6fa82338274be5e4ada847';
        const DEFAULT_VOICES = { "Male": "aa3fdf22-9f5e-4238-8016-31f515ded9a3", "Female": "cbaf8084-f009-4838-a096-07ee2e6612b1" };
        
        // PAIRED VOICES FROM JSON
        const VOICE_MAP = {
            "en": { "Male": "5ee9feff-1265-424a-9d7f-8e4d431a12c7", "Female": "e07c00bc-4134-4eae-9ea4-1a55fb45746b" },
            "hi": { "Male": "7e8cb11d-37af-476b-ab8f-25da99b18644", "Female": "faf0731e-dfb9-4cfc-8119-259a79b27e12" },
            "es": { "Male": "15d0c2e2-8d29-44c3-be23-d585d5f154a1", "Female": "5c5ad5e7-1020-476b-8b91-fdcbe9cc313c" },
            "de": { "Male": "b7187e84-fe22-4344-ba4a-bc013fcb533e", "Female": "38aabb6a-f52b-4fb0-a3d1-988518f4dc06" },
            "ar": { "Male": "f1cdfb4a-bf7d-4e83-916e-8f0802278315", "Female": "002622d8-19d0-4567-a16a-f99c7397c062" },
            "ko": { "Male": "af6beeea-d732-40b6-8292-73af0035b740", "Female": "304fdbd8-65e6-40d6-ab78-f9d18b9efdf9" },
            "fr": { "Male": "0418348a-0ca2-4e90-9986-800fb8b3bbc0", "Female": "a8a1eb38-5f15-4c1d-8722-7ac0f329727d" },
            "ja": { "Male": "e8a863c6-22c7-4671-86ca-91cacffc038d", "Female": "2b568345-1d48-4047-b25f-7baccf842eb0" },
            "pt": { "Male": "6a360542-a117-4ed5-9e09-e8bf9b05eabb", "Female": "d4b44b9a-82bc-4b65-b456-763fce4c52f9" },
            "ta": { "Female": "25d2c432-139c-4035-bfd6-9baaabcdd006" },
            "te": { "Female": "07bc462a-c644-49f1-baf7-82d5599131be" },
            "nl": { "Male": "aa3fdf22-9f5e-4238-8016-31f515ded9a3", "Female": "cbaf8084-f009-4838-a096-07ee2e6612b1" }
        };

        const firebaseConfig = { apiKey: "AIzaSyC93B2GgE3HzaWl5gW_mRroobQybaZNFJs", authDomain: "macx-5feca.firebaseapp.com", databaseURL: "https://macx-5feca-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "macx-5feca" };
        const app = initializeApp(firebaseConfig); const db = getDatabase(app);

        const EMOTIONS = { "neutral": "üòê", "angry": "üò†", "excited": "ü§©", "content": "üòä", "sad": "üò¢", "scared": "üò®", "happy": "üòÄ", "apologetic": "üôá", "curious": "ü§î", "amazed": "üò≤", "triumphant": "üèÜ" };
        const fullLangList = ["Abkhaz","Acehnese","Acholi","Afar","Afrikaans","Albanian","Alur","Amharic","Arabic","Armenian","Assamese","Avar","Awadhi","Aymara","Azerbaijani","Balinese","Baluchi","Bambara","Baoul√©","Bashkir","Basque","Batak Karo","Batak Simalungun","Batak Toba","Belarusian","Bemba","Bengali","Betawi","Bhojpuri","Bikol","Bosnian","Breton","Bulgarian","Buryat","Cantonese","Catalan","Cebuano","Chamorro","Chechen","Chichewa","Chinese (Simplified)","Chinese (Traditional)","Chuukese","Chuvash","Corsican","Crimean Tatar (Cyrillic)","Crimean Tatar (Latin)","Croatian","Czech","Danish","Dari","Dhivehi","Dinka","Dogri","Dombe","Dutch","Dyula","Dzongkha","English","Esperanto","Estonian","Ewe","Faroese","Fijian","Filipino","Finnish","Fon","French","French (Canada)","Frisian","Friulian","Fulani","Ga","Galician","Georgian","German","Greek","Guarani","Gujarati","Haitian Creole","Hakha Chin","Hausa","Hawaiian","Hebrew","Hiligaynon","Hindi","Hmong","Hungarian","Hunsrik","Iban","Icelandic","Igbo","Ilocano","Indonesian","Inuktut (Latin)","Inuktut (Syllabics)","Irish","Italian","Jamaican Patois","Japanese","Javanese","Jingpo","Kalaallisut","Kannada","Kanuri","Kapampangan","Kazakh","Khasi","Khmer","Kiga","Kikongo","Kinyarwanda","Kituba","Kokborok","Komi","Konkani","Korean","Krio","Kurdish (Kurmanji)","Kurdish (Sorani)","Kyrgyz","Lao","Latgalian","Latin","Latvian","Ligurian","Limburgish","Lingala","Lithuanian","Lombard","Luganda","Luo","Luxembourgish","Macedonian","Madurese","Maithili","Makassar","Malagasy","Malay","Malay (Jawi)","Malayalam","Maltese","Mam","Manx","Maori","Marathi","Marshallese","Marwadi","Mauritian Creole","Meadow Mari","Meiteilon (Manipuri)","Minang","Mizo","Mongolian","Myanmar (Burmese)","Nahuatl (Eastern Huasteca)","Ndau","Ndebele (South)","Nepalbhasa (Newari)","Nepali","NKo","Norwegian","Nuer","Occitan","Odia (Oriya)","Oromo","Ossetian","Pangasinan","Papiamento","Pashto","Persian","Polish","Portuguese (Brazil)","Portuguese (Portugal)","Punjabi (Gurmukhi)","Punjabi (Shahmukhi)","Quechua","Q ºeqchi º","Romani","Romanian","Rundi","Russian","Sami (North)","Samoan","Sango","Sanskrit","Santali (Latin)","Santali (Ol Chiki)","Scots Gaelic","Sepedi","Serbian","Sesotho","Seychellois Creole","Shan","Shona","Sicilian","Silesian","Sindhi","Sinhala","Slovak","Slovenian","Somali","Spanish","Sundanese","Susu","Swahili","Swati","Swedish","Tahitian","Tajik","Tamazight","Tamazight (Tifinagh)","Tamil","Tatar","Telugu","Tetum","Thai","Tibetan","Tigrinya","Tiv","Tok Pisin","Tongan","Tshiluba","Tsonga","Tswana","Tulu","Tumbuka","Turkish","Turkmen","Tuvan","Twi","Udmurt","Ukrainian","Urdu","Uyghur","Uzbek","Venda","Venetian","Vietnamese","Waray","Welsh","Wolof","Xhosa","Yakut","Yiddish","Yoruba","Yucatec Maya","Zapotec","Zulu"];

        // --- SESSION STATE ---
        let myUserId = `user-${Math.floor(Math.random()*99999)}`;
        let userData = { name: '', room: 'SUCCESS', gender: 'Male', language: 'nl' };
        let isRec = false, mediaRec, dgSocket, aCtx, aFr, tStart, tInt, activeSegmentRef = null;
        let ttsEnabled = false, joinTimestamp = null;
        const audioQueue = [];
        let isAudioPlaying = false;

        const ui = {
            modal: document.getElementById('gateway-modal'), delModal: document.getElementById('delete-modal'), app: document.getElementById('app-container'), langSelect: document.getElementById('user-lang'), msgWin: document.getElementById('msg-stream'), txtIn: document.getElementById('text-input'), sendBtn: document.getElementById('send-btn'), micBtn: document.getElementById('mic-btn'), voiceOver: document.getElementById('voice-overlay'), timer: document.getElementById('timer'), viz: document.getElementById('viz'), ttsBtn: document.getElementById('tts-toggle-btn'), ttsIcon: document.getElementById('tts-icon'), logout: document.getElementById('logout-btn')
        };

        // --- AUDIO QUEUE SYSTEM (SEQUENTIAL) ---
        async function processAudioQueue() {
            if (isAudioPlaying || audioQueue.length === 0) return;
            isAudioPlaying = true;
            const item = audioQueue.shift();
            try {
                const pair = VOICE_MAP[item.lang] || DEFAULT_VOICES;
                const voiceId = pair[item.gender] || DEFAULT_VOICES[item.gender];
                
                const response = await fetch("https://api.cartesia.ai/tts/bytes", {
                    method: "POST",
                    headers: { "Cartesia-Version": "2025-04-16", "X-API-Key": CARTESIA_KEY, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        "model_id": "sonic-3-latest",
                        "transcript": `<emotion value="${item.emotion || 'neutral'}" />${item.text}`,
                        "voice": { "mode": "id", "id": voiceId },
                        "output_format": { "container": "wav", "encoding": "pcm_f32le", "sample_rate": 44100 },
                        "speed": "normal",
                        "generation_config": { "speed": 1, "volume": 1, "emotion": item.emotion || "neutral" }
                    })
                });

                if (response.ok) {
                    const audio = new Audio(URL.createObjectURL(await response.blob()));
                    audio.onended = () => { isAudioPlaying = false; processAudioQueue(); };
                    await audio.play();
                } else { isAudioPlaying = false; processAudioQueue(); }
            } catch (e) { isAudioPlaying = false; processAudioQueue(); }
        }

        // --- UTILS ---
        function cleanTranscript(t) { return t.replace(/\b(uhm|um|ah|huh|er|eh|hm|uh)\b/gi, "").replace(/\s\s+/g, ' ').trim(); }
        async function translate(text, from, to) {
            if (from === to) return text;
            try {
                const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=${from}&tl=${to}&dt=t&q=${encodeURI(text)}`);
                const d = await res.json(); return d[0][0][0];
            } catch (e) { return text; }
        }

        function getEmotion(text) {
            const l = text.toLowerCase();
            if (l.includes("sorry")) return "apologetic";
            if (l.includes("wow")) return "amazed";
            if (l.includes("angry")) return "angry";
            if (l.includes("happy")) return "happy";
            if (l.includes("why")) return "curious";
            return "neutral";
        }

        // --- FIREBASE OPS ---
        function pushMsg(raw, isFinal = true) {
            const text = cleanTranscript(raw); if (!text) return;
            const emotion = isFinal ? getEmotion(text) : "neutral";
            const path = isFinal ? `chats/${userData.room}/messages` : `chats/${userData.room}/drafts`;
            const tRef = isFinal ? push(ref(db, path)) : (activeSegmentRef || push(ref(db, path)));
            if (!isFinal) activeSegmentRef = tRef;
            set(tRef, { text, senderId: myUserId, senderName: userData.name, gender: userData.gender, lang: userData.language, emotion, emoji: EMOTIONS[emotion] || 'üòê', timestamp: Date.now() });
            if (isFinal && activeSegmentRef) { remove(activeSegmentRef); activeSegmentRef = null; }
        }

        function bindFirebase(room) {
            ui.msgWin.innerHTML = '';
            onChildAdded(ref(db, `chats/${room}/messages`), async (snap) => {
                const msg = snap.val();
                if (msg.senderId !== myUserId && msg.timestamp >= joinTimestamp) {
                    msg.translated = await translate(msg.text, msg.lang, userData.language);
                    audioQueue.push({ text: msg.translated, gender: msg.gender, emotion: msg.emotion, lang: userData.language });
                    if(ttsEnabled) processAudioQueue();
                }
                renderBubble(msg);
            });
            onValue(ref(db, `chats/${room}/drafts`), (snap) => {
                document.querySelectorAll('.is-live').forEach(el => el.remove());
                if (snap.val()) Object.entries(snap.val()).forEach(([key, val]) => renderBubble(val, true));
            });
        }

        function renderBubble(msg, isLive = false) {
            const isMe = msg.senderId === myUserId;
            const div = document.createElement('div');
            div.className = `flex ${isMe ? 'justify-end' : 'justify-start'} ${isLive ? 'is-live opacity-50' : ''}`;
            const content = (!isMe && msg.translated) ? msg.translated : msg.text;
            div.innerHTML = `<div class="${isMe ? 'bg-[#d9fdd3] rounded-tr-none' : 'bg-white rounded-tl-none'} p-2 rounded-lg bubble-shadow max-w-[85%] flex items-end gap-2"><div class="flex-1"><p class="text-[14.5px] text-[#111b21] leading-tight pr-1 pb-1">${content}</p><div class="flex items-center gap-1"><span class="text-[8px] text-gray-400 font-bold uppercase tracking-tighter">${msg.senderName} ‚Ä¢ ${msg.gender} ‚Ä¢ ${msg.lang}</span></div></div><div class="emotion-emoji shrink-0">${msg.emoji || 'üòê'}</div></div>`;
            ui.msgWin.appendChild(div); ui.msgWin.scrollTop = ui.msgWin.scrollHeight;
        }

        // --- ROBUST DEEPGRAM (FIXED PARAMS) ---
        async function startVoice() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                isRec = true; ui.voiceOver.classList.remove('hidden'); setupViz(stream);
                tStart = Date.now();
                tInt = setInterval(() => { const s = Math.floor((Date.now() - tStart)/1000); ui.timer.innerText = `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`; }, 1000);

                const dgClient = createClient(DEEPGRAM_KEY);
                // Fixed: endpointing, punctuate, and smart_format to prevent missed words
                dgSocket = dgClient.listen.live({ 
                    model: "nova-3", language: userData.language, smart_format: true, interim_results: true, 
                    endpointing: 1000, punctuate: true, vad_events: true 
                });

                dgSocket.on(LiveTranscriptionEvents.Open, () => {
                    mediaRec = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                    mediaRec.ondataavailable = (e) => { if (e.data.size > 0 && dgSocket.getReadyState() === 1) dgSocket.send(e.data); };
                    mediaRec.start(250); // 250ms chunks for real-time fidelity
                });

                dgSocket.on(LiveTranscriptionEvents.Transcript, (d) => {
                    const txt = d.channel.alternatives[0].transcript;
                    if (txt.trim()) pushMsg(txt, d.is_final);
                });
            } catch (e) { stopVoice(false); }
        }

        // --- CORE CONNECT ---
        function connect(isAuto = false) {
            if (!isAuto) {
                const n = document.getElementById('user-display-name').value.trim();
                const r = document.getElementById('room-code').value.trim().toUpperCase();
                if(!n) return alert("Enter Display Name");
                userData.name = n.substring(0, 8); userData.room = r || 'SUCCESS';
                userData.gender = document.getElementById('user-gender').value;
                userData.language = ui.langSelect.value;
                joinTimestamp = Date.now();
                localStorage.setItem('orbit_session', JSON.stringify({ ...userData, joinTime: joinTimestamp }));
            }
            ui.modal.classList.add('hidden'); ui.app.classList.remove('opacity-0');
            document.getElementById('room-header-name').innerText = userData.room;
            document.getElementById('sidebar-room-name').innerText = userData.room;
            document.getElementById('user-display-meta').innerText = `${userData.name} ‚Ä¢ ${userData.gender} ‚Ä¢ ${userData.language.toUpperCase()}`;
            document.body.classList.add('mobile-chat-open');
            bindFirebase(userData.room);
        }

        // --- APP INIT ---
        fullLangList.forEach(l => {
            const opt = document.createElement('option');
            const map = { "Dutch": "nl", "Tagalog": "tl", "English": "en", "Spanish": "es", "French": "fr", "German": "de", "Arabic": "ar", "Korean": "ko", "Japanese": "ja", "Portuguese": "pt", "Tamil": "ta", "Telugu": "te", "Hindi": "hi" };
            opt.value = map[l] || "en"; opt.text = l; if(l === "Dutch") opt.selected = true; ui.langSelect.add(opt);
        });

        window.toggleDeleteModal = (show) => ui.delModal.classList.toggle('hidden', !show);
        document.getElementById('confirm-delete-btn').onclick = () => { remove(ref(db, `chats/${userData.room}`)); toggleDeleteModal(false); ui.msgWin.innerHTML = ''; };
        ui.logout.onclick = () => { localStorage.removeItem('orbit_session'); location.reload(); };
        document.getElementById('btn-connect').onclick = () => connect(false);
        ui.ttsBtn.onclick = () => { ttsEnabled = !ttsEnabled; ui.ttsIcon.className = ttsEnabled ? "fa-solid fa-volume-high text-[#008069]" : "fa-solid fa-volume-xmark text-gray-400"; if(ttsEnabled) processAudioQueue(); };
        ui.txtIn.oninput = () => { const v = ui.txtIn.value.trim(); ui.sendBtn.classList.toggle('hidden', v===""); ui.micBtn.classList.toggle('hidden', v!==""); };
        ui.sendBtn.onclick = () => { if(ui.txtIn.value.trim()){ pushMsg(ui.txtIn.value.trim(), true); ui.txtIn.value=''; ui.txtIn.oninput(); } };
        ui.micBtn.onclick = startVoice;
        document.getElementById('stop-voice').onclick = () => { isRec = false; mediaRec?.stop(); dgSocket?.finish(); clearInterval(tInt); ui.voiceOver.classList.add('hidden'); ui.timer.innerText = "00:00"; };
        document.getElementById('cancel-voice').onclick = () => { isRec = false; mediaRec?.stop(); dgSocket?.finish(); clearInterval(tInt); ui.voiceOver.classList.add('hidden'); if(activeSegmentRef) remove(activeSegmentRef); activeSegmentRef = null; };

        function setupViz(s) {
            const vCtx = new AudioContext(); const aAn = vCtx.createAnalyser(); aAn.fftSize = 64; vCtx.createMediaStreamSource(s).connect(aAn);
            const b = new Uint8Array(aAn.frequencyBinCount), ctx = ui.viz.getContext('2d'); ui.viz.width = ui.viz.parentElement.offsetWidth;
            const dr = () => { if(!isRec) return vCtx.close(); requestAnimationFrame(dr); aAn.getByteFrequencyData(b); ctx.clearRect(0,0,ui.viz.width,ui.viz.height);
                let x = 0; for(let i=0; i<b.length; i++) { const h = (b[i]/255)*30; ctx.fillStyle='#00a884'; ctx.beginPath(); ctx.roundRect(x,(30-h)/2,2,h,10); ctx.fill(); x += 5; }
            }; dr();
        }

        const saved = localStorage.getItem('orbit_session');
        if(saved) { const d = JSON.parse(saved); userData = d; joinTimestamp = d.joinTime; connect(true); }
    </script>
</body>
</html>
